<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Panel.ViewModels"
             x:Class="Panel.Views.PaginaPanelAdmin"
             BackgroundColor="{StaticResource Gray50Jazer}"
             xmlns:converters="clr-namespace:Panel.Converters">

    <Grid RowDefinitions="Auto,Auto,Auto,*" ColumnDefinitions="*" x:Name="MainGrid">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="AdaptiveStates">
                <!-- Estado Estrecho (Ventanas pequeÃ±as o verticales) -->
                <VisualState x:Name="NarrowStatus">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter TargetName="StatsGrid" Property="ColumnDefinitions" Value="*,*"/>
                        <Setter TargetName="StatsGrid" Property="RowDefinitions" Value="Auto,Auto"/>
                        <Setter TargetName="BrandingStack" Property="IsVisible" Value="False"/>
                        <Setter TargetName="ServerStatusColumn" Property="HorizontalOptions" Value="Start"/>
                        
                        <!-- AdaptaciÃ³n de Tareas -->
                        <Setter TargetName="TasksGrid" Property="ColumnDefinitions" Value="*"/>
                        <Setter TargetName="TasksGrid" Property="RowDefinitions" Value="Auto,Auto"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Row" Value="1"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Column" Value="0"/>
                        
                        <!-- AdaptaciÃ³n de Usuarios -->
                        <Setter TargetName="UsersGrid" Property="ColumnDefinitions" Value="*"/>
                        <Setter TargetName="UsersGrid" Property="RowDefinitions" Value="Auto,Auto"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Row" Value="1"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Column" Value="0"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Estado Ancho (Escritorio EstÃ¡ndar) -->
                <VisualState x:Name="WideStatus">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="900"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter TargetName="StatsGrid" Property="ColumnDefinitions" Value="*,*,*,*"/>
                        <Setter TargetName="StatsGrid" Property="RowDefinitions" Value="Auto"/>
                        
                        <Setter TargetName="TasksGrid" Property="ColumnDefinitions" Value="350,*"/>
                        <Setter TargetName="TasksGrid" Property="RowDefinitions" Value="Auto"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Column" Value="1"/>

                        <Setter TargetName="UsersGrid" Property="ColumnDefinitions" Value="350,*"/>
                        <Setter TargetName="UsersGrid" Property="RowDefinitions" Value="Auto"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Column" Value="1"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        
        <!-- SECCIÃ“N 1: HEADER SUPERIOR -->
        <Border Grid.Row="0" Margin="0" Padding="32,20" BackgroundColor="White" StrokeThickness="0">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,4" Opacity="0.05" Radius="4"/>
            </Border.Shadow>
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Columna 1: Branding -->
                <HorizontalStackLayout x:Name="BrandingStack" Grid.Column="0" Spacing="16" VerticalOptions="Center">
                    <Image Source="logoconsultoria.jpg" HeightRequest="65" WidthRequest="65" Aspect="AspectFit"/>
                    
                    <!-- Perfil Admin -->
                    <Border HeightRequest="40" WidthRequest="40" StrokeShape="RoundRectangle 20" 
                            BackgroundColor="{StaticResource Blue50}" StrokeThickness="0">
                        <Grid>
                            <Label Text="{Binding UsuarioLogueado.Name, Converter={StaticResource StringToInitialsConverter}}" 
                                   FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Blue600}"
                                   HorizontalOptions="Center" VerticalOptions="Center"/>
                            <Image Source="{Binding UsuarioLogueado.FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                   Aspect="AspectFill"
                                   IsVisible="{Binding UsuarioLogueado.FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                        </Grid>
                    </Border>

                    <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                        <Label Text="Panel de AdministraciÃ³n" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                        <Label Text="{Binding UsuarioLogueado.Name}" FontSize="14" TextColor="{StaticResource Gray500Jazer}"/>
                    </VerticalStackLayout>
                </HorizontalStackLayout>

                <!-- Columna 2: Estado del Servidor (Centrado) -->
                <HorizontalStackLayout x:Name="ServerStatusColumn" Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center" Spacing="16">
                     <Border BackgroundColor="{Binding IsServerRunning, Converter={StaticResource StatusBackgroundColorConverter}}" 
                             StrokeThickness="0" StrokeShape="RoundRectangle 16"
                             Padding="12,6">
                        <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                            <BoxView Color="{Binding IsServerRunning, Converter={StaticResource StatusTextColorConverter}}" HeightRequest="8" WidthRequest="8" CornerRadius="4" VerticalOptions="Center"/>
                            <Label Text="{Binding ConnectionStatus}" FontSize="13" TextColor="{Binding IsServerRunning, Converter={StaticResource StatusTextColorConverter}}"/>
                        </HorizontalStackLayout>
                     </Border>
                     
                     <!-- IP Section -->
                     <Border BackgroundColor="{StaticResource Gray50}" IsVisible="{Binding IsServerRunning}" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="12,4">
                         <HorizontalStackLayout Spacing="10">
                            <Label Text="IP:" FontSize="13" TextColor="{StaticResource Gray500Jazer}" VerticalOptions="Center"/>
                            <Label Text="{Binding ServerIP}" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Green600}" FontFamily="Consolas" VerticalOptions="Center"/>
                            
                            <BoxView WidthRequest="1" Color="{StaticResource Gray200Jazer}" Margin="4,4"/>
                            
                            <Button Text="Copiar" Command="{Binding CopiarIPCommand}" 
                                    BackgroundColor="Transparent" TextColor="{StaticResource Blue600}"
                                    FontAttributes="Bold"
                                    HeightRequest="30" Padding="8,0" FontSize="12"
                                    ToolTipProperties.Text="Copiar IP al portapapeles"/>
                         </HorizontalStackLayout>
                     </Border>
                </HorizontalStackLayout>

                <!-- Columna 3: Controles de SesiÃ³n -->
                <HorizontalStackLayout Grid.Column="2" Spacing="10" VerticalOptions="Center">
                    <Button Text="Iniciar Server" 
                            Command="{Binding IniciarServidorCommand}"
                            IsVisible="{Binding IsServerRunning, Converter={StaticResource InverseBoolConverter}}"
                            BackgroundColor="{StaticResource Green500}" TextColor="White"
                            HeightRequest="36" FontSize="13" Padding="12,0" CornerRadius="6"/>
                    <Button Text="Cerrar SesiÃ³n" 
                            Command="{Binding CerrarSesionCommand}"
                            BackgroundColor="Transparent" TextColor="{StaticResource Gray700Jazer}"
                            BorderColor="{StaticResource Gray300Jazer}" BorderWidth="1"
                            HeightRequest="36" FontSize="13" Padding="12,0" CornerRadius="6"/>
                    <Button Text="ðŸ—‘ï¸" 
                            Command="{Binding ResetDataCommand}"
                            BackgroundColor="{StaticResource Red400}" TextColor="White"
                            HeightRequest="36" WidthRequest="40" Padding="0" CornerRadius="6"
                            ToolTipProperties.Text="Reset BD"/>
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- SECCIÃ“N 2: BARRA DE ESTADÃSTICAS RÃPIDAS -->
        <Border Grid.Row="1" Margin="0" Padding="32,12" BackgroundColor="White" StrokeThickness="0">
            <Grid x:Name="StatsGrid" ColumnDefinitions="*,*,*,*">
                <!-- Stat 1 -->
                <HorizontalStackLayout Grid.Column="0" Spacing="12">
                     <Label Text="Total" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Blue700}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding TotalContadores}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                         <Label Text="Contadores" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                     <BoxView WidthRequest="1" Color="{StaticResource Gray100Jazer}" HorizontalOptions="End" Margin="0,4"/>
                </HorizontalStackLayout>
                
                <!-- Stat 2 -->
                <HorizontalStackLayout Grid.Column="1" Spacing="12" Margin="12,0,0,0">
                     <Label Text="Ã‰xito" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Green600}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding TotalCompletadas}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Green600}"/>
                         <Label Text="Completadas" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                     <BoxView WidthRequest="1" Color="{StaticResource Gray100Jazer}" HorizontalOptions="End" Margin="0,4"/>
                </HorizontalStackLayout>

                <!-- Stat 3 -->
                <HorizontalStackLayout Grid.Column="2" Spacing="12" Margin="12,0,0,0">
                     <Label Text="Pendiente" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Yellow600}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding TotalPendientes}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Yellow600}"/>
                         <Label Text="Pendientes" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                     <BoxView WidthRequest="1" Color="{StaticResource Gray100Jazer}" HorizontalOptions="End" Margin="0,4"/>
                </HorizontalStackLayout>

                <!-- Stat 4 -->
                <HorizontalStackLayout Grid.Column="3" Spacing="12" Margin="12,0,0,0">
                     <Label Text="Eficiencia" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Purple600}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding Eficiencia}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Purple600}"/>
                         <Label Text="Eficiencia" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- SECCIÃ“N 3: SISTEMA DE PESTAÃ‘AS -->
        <Border Grid.Row="2" Margin="0" BackgroundColor="White" StrokeThickness="0" Padding="32,0">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnSpacing="32">
                <Grid.Resources>
                    <Style TargetType="Button" x:Key="TabButton">
                        <Setter Property="BackgroundColor" Value="Transparent"/>
                        <Setter Property="TextColor" Value="{StaticResource Gray500Jazer}"/>
                        <Setter Property="CornerRadius" Value="0"/>
                        <Setter Property="HeightRequest" Value="48"/>
                        <Setter Property="FontSize" Value="14"/>
                        <Setter Property="FontAttributes" Value="None"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="Padding" Value="0"/>
                    </Style>
                    <Style TargetType="BoxView" x:Key="ActiveIndicator">
                        <Setter Property="HeightRequest" Value="3"/>
                        <Setter Property="Color" Value="{StaticResource Blue700}"/>
                        <Setter Property="VerticalOptions" Value="End"/>
                        <Setter Property="IsVisible" Value="False"/>
                    </Style>
                </Grid.Resources>
                
                <!-- Tab 1: Dashboard -->
                <Grid Grid.Column="0">
                    <Button Text="Equipo" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="0">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="0">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="0">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <!-- Tab 2: GestiÃ³n -->
                <Grid Grid.Column="1">
                    <Button Text="GestiÃ³n" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="1">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="1">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="1">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <!-- Tab 3: MensajerÃ­a -->
                <Grid Grid.Column="2">
                    <Button Text="MensajerÃ­a" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="2">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="2">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="2">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <!-- Tab 4: Reportes -->
                <Grid Grid.Column="3">
                    <Button Text="Reportes" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="3">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="3">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="3">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <!-- Tab 5: Usuarios -->
                <Grid Grid.Column="4">
                    <Button Text="Usuarios" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="4">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="4">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="4">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>
            </Grid>
        </Border>

        <!-- SECCIÃ“N 4: CONTENIDO PRINCIPAL -->
        <Grid Grid.Row="3" Padding="32,24">
            <!-- VISTA 0: DASHBOARD / CONTADORES -->
            <ScrollView VerticalScrollBarVisibility="Always" IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=0}">
                <VerticalStackLayout Spacing="24">
                    <!-- Lista Contadores -->
                    <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="24" StrokeShape="RoundRectangle 12" VerticalOptions="Fill">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Equipo de Contadores" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                            
                            <CollectionView ItemsSource="{Binding Contadores}" VerticalScrollBarVisibility="Always" HeightRequest="450">
                                <CollectionView.Header>
                                    <Grid ColumnDefinitions="40,*,*" Padding="0,0,0,8">
                                        <Label Text="" Grid.Column="0"/>
                                        <Label Text="USUARIO" Grid.Column="1" TextColor="{StaticResource Gray400Jazer}" FontSize="11" FontAttributes="Bold"/>
                                        <Label Text="ESTADO" Grid.Column="2" TextColor="{StaticResource Gray400Jazer}" FontSize="11" FontAttributes="Bold" HorizontalOptions="Center"/>
                                    </Grid>
                                </CollectionView.Header>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="40,*,*" Padding="0,12">
                                            <Border Grid.Column="0" HeightRequest="32" WidthRequest="32" StrokeShape="RoundRectangle 16" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0" VerticalOptions="Center" HorizontalOptions="Center">
                                                <Grid>
                                                    <Label Text="{Binding Name, Converter={StaticResource StringToInitialsConverter}}" HorizontalOptions="Center" VerticalOptions="Center" FontSize="11" FontAttributes="Bold" TextColor="{StaticResource Blue600}"/>
                                                    <Image Source="{Binding FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                                           Aspect="AspectFill"
                                                           IsVisible="{Binding FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                </Grid>
                                            </Border>
                                            <Label Grid.Column="1" Text="{Binding Username}" TextColor="{StaticResource Gray800Jazer}" VerticalOptions="Center" FontAttributes="Bold"/>
                                            <Border Grid.Column="2" BackgroundColor="{StaticResource Gray100Jazer}" StrokeThickness="0" Padding="8,2" HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                <Label Text="{Binding Estado}" TextColor="{StaticResource Gray600Jazer}" FontSize="11"/>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </ScrollView>


            <!-- VISTA 1: GESTIÃ“N TAREAS -->
            <ScrollView VerticalScrollBarVisibility="Always" IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=1}">
                <VerticalStackLayout Spacing="24">
                     <Grid ColumnDefinitions="*,2*"> 
                         <VerticalStackLayout Spacing="4">
                             <Label Text="GestiÃ³n de Tareas" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                             <Label Text="Asigna y monitorea tareas" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                         </VerticalStackLayout>
                     </Grid>

                    <Grid x:Name="TasksGrid" ColumnDefinitions="350,*" ColumnSpacing="24">
                        <!-- Formulario Crear (Izquierda) -->
                        <Border x:Name="FormTaskBorder" Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="16">
                                <Label Text="Nueva Tarea" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="TÃ­tulo" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevaTareaTitulo}" Placeholder="Ej: DeclaraciÃ³n Mensual" BackgroundColor="{StaticResource Gray50}" TextColor="{StaticResource Gray900Jazer}"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="DescripciÃ³n" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Editor Text="{Binding NuevaTareaDescripcion}" Placeholder="Detalles..." HeightRequest="80" BackgroundColor="{StaticResource Gray50}" TextColor="{StaticResource Gray900Jazer}"/>
                                </VerticalStackLayout>

                                <Grid ColumnDefinitions="*,*">
                                    <VerticalStackLayout Spacing="4" Margin="0,0,4,0">
                                        <Label Text="Vencimiento" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <DatePicker Date="{Binding NuevaTareaVencimiento}" TextColor="{StaticResource Gray900Jazer}"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4" Margin="4,0,0,0">
                                        <Label Text="Horas Est." FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Entry Text="{Binding NuevaTareaHorasEstimadas}" Keyboard="Numeric" BackgroundColor="{StaticResource Gray50}" TextColor="{StaticResource Gray900Jazer}"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Asignar a" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Picker ItemsSource="{Binding Contadores}" SelectedItem="{Binding NuevaTareaContadorSeleccionado}" ItemDisplayBinding="{Binding Username}" Title="Seleccionar Contador" TextColor="Black" BackgroundColor="{StaticResource Gray50}"/>
                                </VerticalStackLayout>

                                <HorizontalStackLayout Spacing="16">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Prioridad" TextColor="{StaticResource Gray700Jazer}" FontSize="13"/>
                                <Picker ItemsSource="{Binding Prioridades}" SelectedItem="{Binding NuevaTareaPrioridad}" 
                                        BackgroundColor="White" TextColor="{StaticResource Gray800Jazer}"
                                        HeightRequest="40" WidthRequest="150"/>
                            </VerticalStackLayout>
                            
                            <VerticalStackLayout Spacing="8">
                                <Label Text="CategorÃ­a KPI" TextColor="{StaticResource Gray700Jazer}" FontSize="13"/>
                                <Picker ItemsSource="{Binding CategoriasKPI}" SelectedItem="{Binding NuevaTareaCategoriaKPI}" 
                                        BackgroundColor="White" TextColor="{StaticResource Gray800Jazer}"
                                        HeightRequest="40" WidthRequest="180"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                                <Button Text="Crear AsignaciÃ³n" Command="{Binding CrearTareaCommand}" 
                                        BackgroundColor="{StaticResource Blue600}" TextColor="White" FontAttributes="Bold" 
                                        CornerRadius="8" HeightRequest="45" Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Lista Tareas (Derecha) -->
                        <Border x:Name="ListTaskBorder" Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12">
                            <VerticalStackLayout Spacing="16">
                                <Label Text="Asignaciones Recientes" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                                <CollectionView ItemsSource="{Binding Tareas}" EmptyView="No hay tareas asignadas aÃºn" VerticalScrollBarVisibility="Always">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border Margin="0,4" Padding="12" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8">
                                                <Grid ColumnDefinitions="4,*,Auto">
                                                    <BoxView Grid.Column="0" Color="{Binding Prioridad, Converter={StaticResource PriorityToColorConverter}}" VerticalOptions="Fill"/>
                                                    
                                                    <VerticalStackLayout Grid.Column="1" Margin="12,0" Spacing="2">
                                                        <Label Text="{Binding Titulo}" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                                                        <Label Text="{Binding AsignadoAId, StringFormat='Asignado a: #{0}'}" FontSize="11" TextColor="{StaticResource Gray500Jazer}"/>
                                                        <Label Text="{Binding FechaVencimiento, StringFormat='Vence: {0:d}'}" FontSize="11" TextColor="{StaticResource Red400}"/>
                                                    </VerticalStackLayout>
                                                    
                                                    <Border Grid.Column="2" BackgroundColor="{Binding Estado, Converter={StaticResource StatusBackgroundColorConverter}}" StrokeThickness="0" Padding="8,4" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                        <Label Text="{Binding Estado}" TextColor="{Binding Estado, Converter={StaticResource StatusTextColorConverter}}" FontSize="11" FontAttributes="Bold"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>
                </VerticalStackLayout>
            </ScrollView>

            <!-- VISTA 2: MENSAJERÃA -->
            <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=2}" VerticalScrollBarVisibility="Always">
                <Grid RowDefinitions="Auto,*" RowSpacing="24">
                    <VerticalStackLayout Grid.Row="0" Spacing="4">
                         <Label Text="Centro de Mensajes" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                         <Label Text="Comunicaciones internas y alertas" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                    </VerticalStackLayout>
    
                    <Grid Grid.Row="1" ColumnDefinitions="300,*" ColumnSpacing="24">
                        <!-- Controles EnvÃ­o -->
                        <VerticalStackLayout Grid.Column="0" Spacing="24">
                            <!-- Broadcast -->
                            <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12">
                                <VerticalStackLayout Spacing="12">
                                    <Label Text="ðŸ“¢ DifusiÃ³n General" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                                    <Editor Text="{Binding MensajeBroadcastContent}" Placeholder="Mensaje para todos..." HeightRequest="80" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    <Button Text="Enviar a Todos" Command="{Binding EnviarBroadcastCommand}" BackgroundColor="{StaticResource Purple600}" TextColor="White"/>
                                </VerticalStackLayout>
                            </Border>
    
                            <!-- Mensaje Individual -->
                            <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12">
                                <VerticalStackLayout Spacing="12">
                                    <Label Text="ðŸ’¬ Mensaje Directo" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                                    <Picker Title="Destinatario" ItemsSource="{Binding Contadores}" SelectedItem="{Binding DestinatarioMensaje}" ItemDisplayBinding="{Binding Username}" TextColor="Black" BackgroundColor="{StaticResource Gray50}"/>
                                    <Editor Text="{Binding MensajeIndividualContent}" Placeholder="Mensaje privado..." HeightRequest="80" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    <Button Text="Enviar Mensaje" Command="{Binding EnviarMensajeIndividualCommand}" BackgroundColor="{StaticResource Blue600}" TextColor="White"/>
                                </VerticalStackLayout>
                            </Border>
                        </VerticalStackLayout>
    
                        <!-- Historial -->
                        <Border Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="24" StrokeShape="RoundRectangle 12">
                            <Grid RowDefinitions="Auto,*">
                                <Label Grid.Row="0" Text="Historial de Comunicaciones" FontAttributes="Bold" TextColor="{StaticResource Gray700Jazer}" Margin="0,0,0,12"/>
                                <CollectionView Grid.Row="1" ItemsSource="{Binding Mensajes}" VerticalScrollBarVisibility="Always" HeightRequest="500">
                                    <CollectionView.EmptyView>
                                        <Label Text="No hay mensajes registrados" TextColor="{StaticResource Gray400Jazer}" HorizontalOptions="Center" Margin="0,20"/>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="0,8" ColumnDefinitions="Auto,*">
                                                <Label Grid.Column="0" Text="{Binding MarcaTiempo, StringFormat='{0:HH:mm}'}" TextColor="{StaticResource Gray400Jazer}" FontSize="11" VerticalOptions="Start" Margin="0,2,10,0"/>
                                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                    <HorizontalStackLayout Spacing="6">
                                                        <Label Text="{Binding DeNombre}" FontAttributes="Bold" TextColor="{StaticResource Blue700}" FontSize="12"/>
                                                        <Label Text="âž”" FontSize="10" TextColor="{StaticResource Gray400Jazer}" VerticalOptions="Center"/>
                                                        <Label Text="{Binding ParaNombre}" FontAttributes="Bold" TextColor="{StaticResource Gray600Jazer}" FontSize="12"/>
                                                    </HorizontalStackLayout>
                                                    <Label Text="{Binding Contenido}" TextColor="{StaticResource Gray800Jazer}" FontSize="13"/>
                                                </VerticalStackLayout>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollView>

            <!-- VISTA 3: REPORTES -->
            <Grid IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=3}">
                <ScrollView VerticalScrollBarVisibility="Always">
                    <VerticalStackLayout Spacing="24">
                        
                        <!-- Header Dashboard -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Rendimiento del Equipo" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                            <HorizontalStackLayout Grid.Column="1" Spacing="8">
                                <Label Text="Fecha Reporte:" VerticalOptions="Center" TextColor="{StaticResource Gray700Jazer}"/>
                                <DatePicker Date="{Binding FechaReporte}" TextColor="{StaticResource Gray900Jazer}" BackgroundColor="White"/>
                                <Button Text="ðŸ”„" Command="{Binding RefreshCommand}" 
                                        BackgroundColor="{StaticResource Gray100Jazer}" TextColor="{StaticResource Gray900Jazer}"
                                        HeightRequest="36" WidthRequest="40" Padding="0" CornerRadius="6"
                                        ToolTipProperties.Text="Actualizar Datos"/>
                            </HorizontalStackLayout>
                        </Grid>

                        <!-- 1. Tabla Desglose KPIs Diario (ACUMULATIVO) - UNIFICADO -->
                        <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="0">
                            <VerticalStackLayout>
                                <Label Text="Cumplimiento Mensual (Acumulado al DÃ­a)" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}" Margin="20,16,20,8"/>
                                <Grid RowDefinitions="Auto,*" Margin="0,0,0,16">
                                    <CollectionView ItemsSource="{Binding ReportesKPI}" VerticalScrollBarVisibility="Always" HeightRequest="300">
                                        <CollectionView.Header>
                                             <Grid ColumnDefinitions="2*,*,*,*" Padding="20,8" BackgroundColor="{StaticResource Gray100}">
                                                 <Label Grid.Column="0" Text="CATEGORÃA" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                                 <Label Grid.Column="1" Text="TOTAL MES" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                                 <Label Grid.Column="2" Text="HECHO (ACUM)" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                                 <Label Grid.Column="3" Text="%" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                             </Grid>
                                        </CollectionView.Header>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <VerticalStackLayout Spacing="0">
                                                    <Grid ColumnDefinitions="2*,*,*,*" Padding="20,12,20,4">
                                                        <Label Grid.Column="0" Text="{Binding Categoria}" FontAttributes="Bold" TextColor="Black"/>
                                                        <Label Grid.Column="1" Text="{Binding TotalTareas}" HorizontalOptions="Center" TextColor="Black"/>
                                                        <Label Grid.Column="2" Text="{Binding Completadas}" HorizontalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                        <Border Grid.Column="3" BackgroundColor="{Binding ColorEstado}" Padding="8,2" StrokeThickness="0" StrokeShape="RoundRectangle 4" HorizontalOptions="Center">
                                                            <Label Text="{Binding PorcentajeTexto}" TextColor="White" FontAttributes="Bold" FontSize="12"/>
                                                        </Border>
                                                    </Grid>
                                                    <ProgressBar Progress="{Binding Porcentaje}" ProgressColor="{Binding ColorEstado}" HeightRequest="4" Margin="20,0,20,12" BackgroundColor="{StaticResource Gray50Jazer}"/>
                                                    <BoxView HeightRequest="1" Color="{StaticResource Gray100Jazer}"/>
                                                </VerticalStackLayout>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </VerticalStackLayout>
                        </Border>

                        <!-- KPI Cards (Resumen Global) -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="16">
                            <!-- Card 1: Empleado del Mes -->
                            <Border Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="16">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="Mejor Rendimiento" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                                    <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                        <Label Text="ðŸ†" FontSize="20" VerticalOptions="Center"/>
                                        <VerticalStackLayout>
                                            <Label Text="{Binding MejorContadorNombre}" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue600}"/>
                                            <Label Text="{Binding MejorContadorEficiencia, StringFormat='Eficiencia: {0}'}" FontSize="10" TextColor="{StaticResource Green600}"/>
                                        </VerticalStackLayout>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                            
                            <!-- Card 2: Eficiencia Global -->
                            <Border Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="16">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="Eficiencia Promedio" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                                    <Label Text="{Binding PromedioEficiencia}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Purple600}"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Card 3: Horas Totales -->
                            <Border Grid.Column="2" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="16">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="Total Horas Invertidas" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                                    <Label Text="{Binding TotalHorasEquipo}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Blue500}"/>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <!-- GrÃ¡fico Comparativo -->
                        <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="24">
                            <VerticalStackLayout Spacing="16">
                                <Label Text="Comparativa de Eficiencia" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                                
                                <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Default">
                                    <StackLayout BindableLayout.ItemsSource="{Binding ReportesDetallados}" 
                                                 Orientation="Horizontal" 
                                                 Spacing="24"
                                                 HeightRequest="200"
                                                 VerticalOptions="End">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate>
                                                <VerticalStackLayout Spacing="8" VerticalOptions="End">
                                                    <Label Text="{Binding EficienciaTexto}" FontSize="10" HorizontalOptions="Center" TextColor="Black"/>
                                                    <BoxView Color="{Binding ColorEstado}" WidthRequest="40" HeightRequest="{Binding BarHeight}" CornerRadius="4,4,0,0" HorizontalOptions="Center"/>
                                                    <Label Text="{Binding Nombre}" FontSize="10" HorizontalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                </VerticalStackLayout>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </StackLayout>
                                </ScrollView>
                            </VerticalStackLayout>
                        </Border>
                        
                        <!-- Tabla Detallada -->
                        <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="0">
                            <Grid RowDefinitions="Auto,*">
                                <!-- Header Tabla Reportes -->
                                <Grid Grid.Row="0" ColumnDefinitions="2*,*,*,*,*" BackgroundColor="{StaticResource Gray100}" Padding="20,12">
                                    <Label Grid.Column="0" Text="CONTADOR" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="1" Text="TOTAL" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="2" Text="HECHO" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="3" Text="PENDIENTE" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="4" Text="HORAS" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                </Grid>
                                
                                <!-- Lista Reportes -->
                                <CollectionView Grid.Row="1" ItemsSource="{Binding ReportesDetallados}" VerticalScrollBarVisibility="Always" HeightRequest="400">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="2*,*,*,*,*" Padding="20,16">
                                                <HorizontalStackLayout Grid.Column="0" Spacing="10">
                                                    <Border HeightRequest="24" WidthRequest="24" StrokeShape="RoundRectangle 12" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0">
                                                        <Grid>
                                                            <Label Text="{Binding Nombre, Converter={StaticResource StringToInitialsConverter}}" FontSize="9" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource Blue600}" FontAttributes="Bold"/>
                                                            <Image Source="{Binding Contador.FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                                                   Aspect="AspectFill"
                                                                   IsVisible="{Binding Contador.FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                        </Grid>
                                                    </Border>
                                                    <Label Text="{Binding Nombre}" VerticalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                </HorizontalStackLayout>
                                                
                                                <Label Grid.Column="1" Text="{Binding TotalTareas}" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                <Label Grid.Column="2" Text="{Binding Completadas}" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource Green600}" FontAttributes="Bold"/>
                                                <Label Grid.Column="3" Text="{Binding Pendientes}" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource Yellow600}" FontAttributes="Bold"/>
                                                
                                                <HorizontalStackLayout Grid.Column="4" Spacing="4" HorizontalOptions="Center" VerticalOptions="Center">
                                                    <Label Text="{Binding TiempoTrabajadoTexto}" TextColor="{StaticResource Purple600}" FontSize="12" FontAttributes="Bold"/>
                                                </HorizontalStackLayout>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>

                    </VerticalStackLayout>
                </ScrollView>
            </Grid>

            <!-- VISTA 4: GESTIÃ“N DE USUARIOS -->
            <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=4}" VerticalScrollBarVisibility="Always">
                <Grid RowDefinitions="Auto,*" RowSpacing="24">
                    <VerticalStackLayout Grid.Row="0" Spacing="4">
                         <Label Text="GestiÃ³n de Usuarios" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                         <Label Text="Crear, editar y eliminar usuarios del sistema" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                    </VerticalStackLayout>
    
                    <Grid x:Name="UsersGrid" Grid.Row="1" ColumnDefinitions="350,*" ColumnSpacing="24">
                        <!-- Formulario Crear/Editar Usuario (Izquierda) -->
                        <Border x:Name="FormUserBorder" Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="16">
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding IsEditMode, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Editar Usuario|Nuevo Usuario'}" 
                                           FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                    <Button Text="Cancelar" Command="{Binding CancelarEdicionCommand}" 
                                            IsVisible="{Binding IsEditMode}"
                                            BackgroundColor="Transparent" TextColor="{StaticResource Red400}"
                                            HeightRequest="30" Padding="8,0"/>
                                </HorizontalStackLayout>
                                
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Nombre Completo" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevoUsuarioNombre}" Placeholder="Ej: MarÃ­a GarcÃ­a" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>
    
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Usuario (Login)" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevoUsuarioUsername}" Placeholder="Ej: maria" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>
    
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="ContraseÃ±a" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevoUsuarioPassword}" Placeholder="Nueva contraseÃ±a" IsPassword="True" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>
    
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Rol" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding Roles}" SelectedItem="{Binding NuevoUsuarioRol}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="Ãrea" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding Areas}" SelectedItem="{Binding NuevoUsuarioArea}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                </Grid>
    
                                <Button Text="{Binding IsEditMode, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Guardar Cambios|Crear Usuario'}" 
                                        Command="{Binding GuardarUsuarioCommand}" 
                                        BackgroundColor="{StaticResource Blue600}" TextColor="White" FontAttributes="Bold" 
                                        CornerRadius="8" HeightRequest="45" Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </Border>
    
                        <!-- Lista de Usuarios (Derecha) -->
                        <Border x:Name="ListUserBorder" Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="0" StrokeShape="RoundRectangle 12">
                                <!-- Contenedor con Scroll Horizontal -->
                                <ScrollView Grid.Row="1" Orientation="Horizontal" HorizontalScrollBarVisibility="Always">
                                    <Grid RowDefinitions="Auto,*" WidthRequest="800">
                                        <!-- Header Tabla (Ancho Fijo) -->
                                        <Grid Grid.Row="0" ColumnDefinitions="60,200,120,100,120,150" BackgroundColor="{StaticResource Gray100}" Padding="20,12">
                                            <Label Grid.Column="0" Text="FOTO" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                            <Label Grid.Column="1" Text="NOMBRE" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                            <Label Grid.Column="2" Text="USUARIO" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                            <Label Grid.Column="3" Text="ROL" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="4" Text="ÃREA" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="5" Text="ACCIONES" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                        </Grid>
                                        
                                        <!-- Lista Usuarios (Ancho Fijo) -->
                                        <CollectionView Grid.Row="1" ItemsSource="{Binding TodosLosUsuarios}" VerticalScrollBarVisibility="Always" HeightRequest="600">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid ColumnDefinitions="60,200,120,100,120,150" Padding="20,12">
                                                        <!-- Foto Perfil (Imagen o Iniciales) -->
                                                        <Border Grid.Column="0" HeightRequest="40" WidthRequest="40" StrokeShape="RoundRectangle 20" 
                                                                BackgroundColor="{StaticResource Blue50}" StrokeThickness="0">
                                                            <Grid>
                                                                <Label Text="{Binding Name, Converter={StaticResource StringToInitialsConverter}}" 
                                                                       FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Blue600}"
                                                                       HorizontalOptions="Center" VerticalOptions="Center"/>
                                                                
                                                                <Image Source="{Binding FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                                                       Aspect="AspectFill"
                                                                       IsVisible="{Binding FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                            </Grid>
                                                        </Border>
                                                        
                                                        <Label Grid.Column="1" Text="{Binding Name}" VerticalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                        <Label Grid.Column="2" Text="{Binding Username}" VerticalOptions="Center" TextColor="{StaticResource Gray600Jazer}"/>
                                                        
                                                        <Border Grid.Column="3" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0" Padding="8,4" 
                                                                HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                            <Label Text="{Binding Role}" TextColor="{StaticResource Blue600}" FontSize="11" FontAttributes="Bold"/>
                                                        </Border>
                                                        
                                                        <Label Grid.Column="4" Text="{Binding Area}" VerticalOptions="Center" TextColor="{StaticResource Gray600Jazer}" HorizontalOptions="Center"/>
                                                        
                                                        <!-- Botones Acciones -->
                                                        <HorizontalStackLayout Grid.Column="5" Spacing="8" HorizontalOptions="Center" VerticalOptions="Center">
                                                            <Button Text="ðŸ“·" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeleccionarFotoCommand}" 
                                                                    CommandParameter="{Binding .}"
                                                                    BackgroundColor="{StaticResource Gray100Jazer}" TextColor="Black"
                                                                    HeightRequest="32" WidthRequest="32" Padding="0" CornerRadius="6"
                                                                    ToolTipProperties.Text="Cambiar Foto"/>
                                                            <Button Text="âœï¸" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IniciarEdicionCommand}" 
                                                                    CommandParameter="{Binding .}"
                                                                    BackgroundColor="{StaticResource Blue50}" TextColor="{StaticResource Blue600}"
                                                                    HeightRequest="32" WidthRequest="32" Padding="0" CornerRadius="6"
                                                                    ToolTipProperties.Text="Editar"/>
                                                            <Button Text="ðŸ—‘ï¸" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EliminarUsuarioCommand}" 
                                                                    CommandParameter="{Binding .}"
                                                                    BackgroundColor="{StaticResource Red50}" TextColor="{StaticResource Red400}"
                                                                    HeightRequest="32" WidthRequest="32" Padding="0" CornerRadius="6"
                                                                    ToolTipProperties.Text="Eliminar"/>
                                                        </HorizontalStackLayout>
                                                    </Grid>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </Grid>
                                </ScrollView>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollView>

        </Grid>
    </Grid>
</ContentPage>
