<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Panel.ViewModels"
             x:Class="Panel.Views.PaginaPanelAdmin"
             BackgroundColor="{StaticResource Gray50}"
             xmlns:converters="clr-namespace:Panel.Converters">

    <Grid RowDefinitions="Auto,Auto,Auto,*" ColumnDefinitions="*" x:Name="MainGrid">
        <!-- Estados adaptativos para escritorio/móvil -->
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="AdaptiveStates">
                <VisualState x:Name="NarrowStatus">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter TargetName="StatsGrid" Property="ColumnDefinitions" Value="*,*"/>
                        <Setter TargetName="StatsGrid" Property="RowDefinitions" Value="Auto,Auto"/>
                        <Setter TargetName="BrandingStack" Property="IsVisible" Value="False"/>
                        <Setter TargetName="ServerStatusColumn" Property="HorizontalOptions" Value="Start"/>
                        
                        <Setter TargetName="TasksGrid" Property="ColumnDefinitions" Value="*"/>
                        <Setter TargetName="TasksGrid" Property="RowDefinitions" Value="Auto,Auto"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Row" Value="1"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Column" Value="0"/>
                        
                        <Setter TargetName="UsersGrid" Property="ColumnDefinitions" Value="*"/>
                        <Setter TargetName="UsersGrid" Property="RowDefinitions" Value="Auto,Auto"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Row" Value="1"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Column" Value="0"/>
                    </VisualState.Setters>
                </VisualState>
                
                <VisualState x:Name="WideStatus">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="900"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter TargetName="StatsGrid" Property="ColumnDefinitions" Value="*,*,*,*"/>
                        <Setter TargetName="StatsGrid" Property="RowDefinitions" Value="Auto"/>
                        
                        <Setter TargetName="TasksGrid" Property="ColumnDefinitions" Value="350,*"/>
                        <Setter TargetName="TasksGrid" Property="RowDefinitions" Value="Auto"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormTaskBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="ListTaskBorder" Property="Grid.Column" Value="1"/>

                        <Setter TargetName="UsersGrid" Property="ColumnDefinitions" Value="350,*"/>
                        <Setter TargetName="UsersGrid" Property="RowDefinitions" Value="Auto"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="FormUserBorder" Property="Grid.Column" Value="0"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Row" Value="0"/>
                        <Setter TargetName="ListUserBorder" Property="Grid.Column" Value="1"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        
        <!-- Barra superior: branding y estado del servidor -->
        <Border Grid.Row="0" Margin="0" Padding="32,20" BackgroundColor="White" StrokeThickness="0">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,4" Opacity="0.05" Radius="4"/>
            </Border.Shadow>
            <Grid ColumnDefinitions="Auto,*,Auto">
                <HorizontalStackLayout x:Name="BrandingStack" Grid.Column="0" Spacing="16" VerticalOptions="Center">
                    <Image Source="logoconsultoria.jpg" HeightRequest="65" WidthRequest="65" Aspect="AspectFit"/>
                    
                    <Border HeightRequest="40" WidthRequest="40" StrokeShape="RoundRectangle 20" 
                            BackgroundColor="{StaticResource Blue50}" StrokeThickness="0">
                        <Grid>
                            <Label Text="{Binding UsuarioLogueado.Name, Converter={StaticResource StringToInitialsConverter}}" 
                                   FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Blue600}"
                                   HorizontalOptions="Center" VerticalOptions="Center"/>
                            <Image Source="{Binding UsuarioLogueado.FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                   Aspect="AspectFill"
                                   IsVisible="{Binding UsuarioLogueado.FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                        </Grid>
                    </Border>

                    <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                        <Label Text="Panel de Administración" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                        <Label Text="{Binding UsuarioLogueado.Name}" FontSize="14" TextColor="{StaticResource Gray500Jazer}"/>
                    </VerticalStackLayout>
                </HorizontalStackLayout>

                <HorizontalStackLayout x:Name="ServerStatusColumn" Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center" Spacing="16">
                     <Border BackgroundColor="{Binding IsServerRunning, Converter={StaticResource StatusBackgroundColorConverter}}" 
                             StrokeThickness="0" StrokeShape="RoundRectangle 16"
                             Padding="12,6">
                        <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                            <BoxView Color="{Binding IsServerRunning, Converter={StaticResource StatusTextColorConverter}}" HeightRequest="8" WidthRequest="8" CornerRadius="4" VerticalOptions="Center"/>
                            <Label Text="{Binding ConnectionStatus}" FontSize="13" TextColor="{Binding IsServerRunning, Converter={StaticResource StatusTextColorConverter}}"/>
                        </HorizontalStackLayout>
                     </Border>
                     
                     <Border BackgroundColor="{StaticResource Gray50}" IsVisible="{Binding IsServerRunning}" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="12,4">
                         <HorizontalStackLayout Spacing="10">
                            <Label Text="IP:" FontSize="13" TextColor="{StaticResource Gray500Jazer}" VerticalOptions="Center"/>
                            <Label Text="{Binding ServerIP}" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Green600}" FontFamily="Consolas" VerticalOptions="Center"/>
                            
                            <BoxView WidthRequest="1" Color="{StaticResource Gray200Jazer}" Margin="4,4"/>
                            
                            <Button Text="Copiar" Command="{Binding CopiarIPCommand}" 
                                    BackgroundColor="Transparent" TextColor="{StaticResource Blue600}"
                                    FontAttributes="Bold"
                                    HeightRequest="30" Padding="8,0" FontSize="12"
                                    ToolTipProperties.Text="Copiar IP al portapapeles"/>
                         </HorizontalStackLayout>
                     </Border>
                </HorizontalStackLayout>

                <HorizontalStackLayout Grid.Column="2" Spacing="10" VerticalOptions="Center">
                    <Button Text="Iniciar Server" 
                            Command="{Binding IniciarServidorCommand}"
                            IsVisible="{Binding IsServerRunning, Converter={StaticResource InverseBoolConverter}}"
                            BackgroundColor="{StaticResource Green500}" TextColor="White"
                            HeightRequest="36" FontSize="13" Padding="12,0" CornerRadius="6"/>
                    <Button Text="Cerrar Sesión" 
                            Command="{Binding CerrarSesionCommand}"
                            BackgroundColor="Transparent" TextColor="{StaticResource Gray700Jazer}"
                            BorderColor="{StaticResource Gray300Jazer}" BorderWidth="1"
                            HeightRequest="36" FontSize="13" Padding="12,0" CornerRadius="6"/>
                    <Button Text="Backup" 
                            Command="{Binding DescargarBackupCommand}"
                            BackgroundColor="{StaticResource Blue600}" TextColor="White"
                            HeightRequest="36" FontSize="12" Padding="12,0" CornerRadius="6"
                            ToolTipProperties.Text="Descargar copia de seguridad"/>
                    <Border BackgroundColor="{StaticResource Red400}"
                            HeightRequest="36" WidthRequest="40" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                            ToolTipProperties.Text="Reset BD">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ResetDataCommand}"/>
                        </Border.GestureRecognizers>
                        <Path Data="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" 
                              Stroke="White" StrokeThickness="1.5" 
                              WidthRequest="18" HeightRequest="18" Aspect="Uniform"
                              HorizontalOptions="Center" VerticalOptions="Center"/>
                    </Border>
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- Métricas rápidas del equipo -->
        <Border Grid.Row="1" Margin="0" Padding="32,12" BackgroundColor="White" StrokeThickness="0">
            <Grid x:Name="StatsGrid" ColumnDefinitions="*,*,*,*">
                <HorizontalStackLayout Grid.Column="0" Spacing="12">
                     <Label Text="Total" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Blue700}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding TotalContadores}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                         <Label Text="Contadores" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                     <BoxView WidthRequest="1" Color="{StaticResource Gray100Jazer}" HorizontalOptions="End" Margin="0,4"/>
                </HorizontalStackLayout>
                
                <HorizontalStackLayout Grid.Column="1" Spacing="12" Margin="12,0,0,0">
                     <Label Text="Éxito" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Green600}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding TotalCompletadas}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Green600}"/>
                         <Label Text="Completadas" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                     <BoxView WidthRequest="1" Color="{StaticResource Gray100Jazer}" HorizontalOptions="End" Margin="0,4"/>
                </HorizontalStackLayout>

                <HorizontalStackLayout Grid.Column="2" Spacing="12" Margin="12,0,0,0">
                     <Label Text="Pendiente" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Yellow600}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding TotalPendientes}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Yellow600}"/>
                         <Label Text="Pendientes" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                     <BoxView WidthRequest="1" Color="{StaticResource Gray100Jazer}" HorizontalOptions="End" Margin="0,4"/>
                </HorizontalStackLayout>

                <HorizontalStackLayout Grid.Column="3" Spacing="12" Margin="12,0,0,0">
                     <Label Text="Eficiencia" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Purple600}" VerticalOptions="Center"/>
                     <VerticalStackLayout>
                         <Label Text="{Binding Eficiencia}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Purple600}"/>
                         <Label Text="Eficiencia" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                     </VerticalStackLayout>
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- Navegación por pestañas principales -->
        <Border Grid.Row="2" Margin="0" BackgroundColor="White" StrokeThickness="0" Padding="32,0">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="32">
                <Grid.Resources>
                    <Style TargetType="Button" x:Key="TabButton">
                        <Setter Property="BackgroundColor" Value="Transparent"/>
                        <Setter Property="TextColor" Value="{StaticResource Gray500Jazer}"/>
                        <Setter Property="CornerRadius" Value="0"/>
                        <Setter Property="HeightRequest" Value="48"/>
                        <Setter Property="FontSize" Value="14"/>
                        <Setter Property="FontAttributes" Value="None"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="Padding" Value="0"/>
                    </Style>
                    <Style TargetType="BoxView" x:Key="ActiveIndicator">
                        <Setter Property="HeightRequest" Value="3"/>
                        <Setter Property="Color" Value="{StaticResource Blue700}"/>
                        <Setter Property="VerticalOptions" Value="End"/>
                        <Setter Property="IsVisible" Value="False"/>
                    </Style>
                </Grid.Resources>
                
                <Grid Grid.Column="0">
                    <Button Text="Equipo" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="0">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="0">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="0">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="1">
                    <Button Text="Gestión" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="1">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="1">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="1">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="2">
                    <Button Text="Plantillas" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="2">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="2">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="2">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="3">
                    <Button Text="Etiquetas" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="3">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="3">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="3">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="4">
                    <Button Text="Mensajería" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="4">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="4">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="4">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="5">
                    <Button Text="Reportes" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="5">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="5">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="5">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="6">
                    <Button Text="Usuarios" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="6">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="6">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="6">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>

                <Grid Grid.Column="7">
                    <Button Text="Documentos" Style="{StaticResource TabButton}" 
                            Command="{Binding SetTabCommand}" CommandParameter="7">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding SelectedTabIndex}" Value="7">
                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                <Setter Property="FontAttributes" Value="Bold"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <BoxView Style="{StaticResource ActiveIndicator}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding SelectedTabIndex}" Value="7">
                                <Setter Property="IsVisible" Value="True"/>
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>
                </Grid>
            </Grid>
        </Border>

        <!-- Contenido por pestaña: equipo, gestión, mensajería, reportes, usuarios -->
        <Grid Grid.Row="3" Padding="32,24">
            <ScrollView VerticalScrollBarVisibility="Always" IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=0}">
                <VerticalStackLayout Spacing="24">
                   
                    <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="24" StrokeShape="RoundRectangle 12" VerticalOptions="Fill">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Equipo de Contadores" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                            
                            <CollectionView ItemsSource="{Binding Contadores}" VerticalScrollBarVisibility="Always" HeightRequest="450">
                                <CollectionView.Header>
                                    <Grid ColumnDefinitions="40,2*,*" Padding="0,0,0,8">
                                        <Label Text="" Grid.Column="0"/>
                                        <Label Text="USUARIO" Grid.Column="1" TextColor="{StaticResource Gray400Jazer}" FontSize="11" FontAttributes="Bold"/>
                                        <Label Text="ESTADO" Grid.Column="2" TextColor="{StaticResource Gray400Jazer}" FontSize="11" FontAttributes="Bold" HorizontalOptions="Center"/>
                                    </Grid>
                                </CollectionView.Header>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="40,2*,*" Padding="0,12">
                                            <Border Grid.Column="0" HeightRequest="32" WidthRequest="32" StrokeShape="RoundRectangle 16" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0" VerticalOptions="Center" HorizontalOptions="Center">
                                                <Grid>
                                                    <Label Text="{Binding Name, Converter={StaticResource StringToInitialsConverter}}" HorizontalOptions="Center" VerticalOptions="Center" FontSize="11" FontAttributes="Bold" TextColor="{StaticResource Blue600}"/>
                                                    <Image Source="{Binding FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                                           Aspect="AspectFill"
                                                           IsVisible="{Binding FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                </Grid>
                                            </Border>
                                            <Label Grid.Column="1" Text="{Binding Username}" TextColor="{StaticResource Gray800Jazer}" VerticalOptions="Center" FontAttributes="Bold"/>
                                            <Border Grid.Column="2" BackgroundColor="{Binding Estado, Converter={StaticResource StatusBackgroundColorConverter}}" StrokeThickness="0" Padding="8,2" HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                <Label Text="{Binding Estado}" TextColor="{Binding Estado, Converter={StaticResource StatusTextColorConverter}}" FontSize="11"/>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </ScrollView>


            <ScrollView VerticalScrollBarVisibility="Always" IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=1}">
                <VerticalStackLayout Spacing="24">
                     <Grid ColumnDefinitions="*,2*"> 
                         <VerticalStackLayout Spacing="4">
                             <Label Text="Gestión de Tareas" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                             <Label Text="Asigna y monitorea tareas" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                         </VerticalStackLayout>
                     </Grid>

                    <Grid x:Name="TasksGrid" ColumnDefinitions="350,*" ColumnSpacing="24">
            
                        <Border x:Name="FormTaskBorder" Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="16">
                                <Label Text="Nueva Tarea" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Título" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevaTareaTitulo}" Placeholder="Ej: Declaración Mensual" BackgroundColor="{StaticResource Gray50}" TextColor="{StaticResource Gray900Jazer}"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Descripción" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Editor Text="{Binding NuevaTareaDescripcion}" Placeholder="Detalles..." HeightRequest="80" BackgroundColor="{StaticResource Gray50}" TextColor="{StaticResource Gray900Jazer}"/>
                                </VerticalStackLayout>

                                <Grid ColumnDefinitions="*,*">
                                    <VerticalStackLayout Spacing="4" Margin="0,0,4,0">
                                        <Label Text="Vencimiento" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <DatePicker Date="{Binding NuevaTareaVencimiento}" TextColor="{StaticResource Gray900Jazer}"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4" Margin="4,0,0,0">
                                        <Label Text="Horas Est." FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Entry Text="{Binding NuevaTareaHorasEstimadas}" Keyboard="Numeric" BackgroundColor="{StaticResource Gray50}" TextColor="{StaticResource Gray900Jazer}"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Asignar a" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Picker ItemsSource="{Binding Contadores}" SelectedItem="{Binding NuevaTareaContadorSeleccionado}" ItemDisplayBinding="{Binding Username}" Title="Seleccionar Contador" TextColor="Black" BackgroundColor="{StaticResource Gray50}"/>
                                </VerticalStackLayout>

                                <HorizontalStackLayout Spacing="16">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Prioridad" TextColor="{StaticResource Gray700Jazer}" FontSize="13"/>
                                <Picker ItemsSource="{Binding Prioridades}" SelectedItem="{Binding NuevaTareaPrioridad}" 
                                        BackgroundColor="White" TextColor="{StaticResource Gray800Jazer}"
                                        HeightRequest="40" WidthRequest="150"/>
                            </VerticalStackLayout>
                            
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Categoría KPI" TextColor="{StaticResource Gray700Jazer}" FontSize="13"/>
                                <Picker ItemsSource="{Binding CategoriasKPI}" SelectedItem="{Binding NuevaTareaCategoriaKPI}" 
                                        BackgroundColor="White" TextColor="{StaticResource Gray800Jazer}"
                                        HeightRequest="40" WidthRequest="180"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                                <Button Text="Crear Asignación" Command="{Binding CrearTareaCommand}" 
                                        BackgroundColor="{StaticResource Blue600}" TextColor="White" FontAttributes="Bold" 
                                        CornerRadius="8" HeightRequest="45" Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </Border>

                        <Border x:Name="ListTaskBorder" Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12">
                            <Grid RowDefinitions="Auto,*">
                                <Label Grid.Row="0" Text="Asignaciones Recientes" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}" Margin="0,0,0,12"/>
                                <CollectionView Grid.Row="1" ItemsSource="{Binding Tareas}" VerticalScrollBarVisibility="Always" HeightRequest="400">
                                    <CollectionView.EmptyView>
                                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12" Padding="20">
                                            <Border BackgroundColor="{StaticResource Gray100}" StrokeShape="RoundRectangle 25" 
                                                    HeightRequest="50" WidthRequest="50" StrokeThickness="0" HorizontalOptions="Center">
                                                <Path Data="M9 2H15L21 8V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V4C3 2.9 3.9 2 5 2H9M19 8H14V3" 
                                                      Stroke="{StaticResource Gray400Jazer}" StrokeThickness="1.5" WidthRequest="20" HeightRequest="20"
                                                      Aspect="Uniform" HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Border>
                                            <Label Text="No hay tareas asignadas aún" TextColor="{StaticResource Gray400Jazer}" HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border Margin="0,4" Padding="12" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8">
                                                <Grid ColumnDefinitions="4,*,Auto,Auto" ColumnSpacing="8">
                                                    <BoxView Grid.Column="0" Color="{Binding Prioridad, Converter={StaticResource PriorityToColorConverter}}" VerticalOptions="Fill"/>
                                                    
                                                    <VerticalStackLayout Grid.Column="1" Margin="8,0" Spacing="2">
                                                        <Label Text="{Binding Titulo}" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}" LineBreakMode="TailTruncation" MaxLines="1"/>
                                                        <Label Text="{Binding AsignadoAId, StringFormat='Asignado a: #{0}'}" FontSize="11" TextColor="{StaticResource Gray500Jazer}"/>
                                                        <Label Text="{Binding FechaVencimiento, StringFormat='Vence: {0:d}'}" FontSize="11" TextColor="{StaticResource Red400}"/>
                                                    </VerticalStackLayout>
                                                    
                                                    <!-- Botón de etiquetas -->
                                                    <Border Grid.Column="2"
                                                            BackgroundColor="{StaticResource Gray100}"
                                                            HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                            VerticalOptions="Center"
                                                            ToolTipProperties.Text="Asignar etiquetas">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AbrirEtiquetasDeTareaCommand}" CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z M6 6h.008v.008H6V6Z" 
                                                              Stroke="{StaticResource Gray700Jazer}" StrokeThickness="1.5" 
                                                              WidthRequest="16" HeightRequest="16" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                    
                                                    <Border Grid.Column="3" BackgroundColor="{Binding Estado, Converter={StaticResource StatusBackgroundColorConverter}}" StrokeThickness="0" Padding="8,4" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                        <Label Text="{Binding Estado}" TextColor="{Binding Estado, Converter={StaticResource StatusTextColorConverter}}" FontSize="11" FontAttributes="Bold"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                    </Grid>
                </VerticalStackLayout>
            </ScrollView>

            <!-- PESTAÑA 2: PLANTILLAS DE TAREAS -->
            <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=2}" VerticalScrollBarVisibility="Always">
                <Grid RowDefinitions="Auto,*" RowSpacing="24">
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Plantillas de Tareas" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                            <Label Text="Crea plantillas para tareas recurrentes y genera tareas automáticamente" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                        </VerticalStackLayout>
                        <Button Grid.Column="1" Text="Generar Tareas Recurrentes" 
                                Command="{Binding GenerarTareasRecurrentesCommand}"
                                BackgroundColor="{StaticResource Green500}" TextColor="White"
                                HeightRequest="40" Padding="16,0" CornerRadius="8"/>
                    </Grid>

                    <Grid Grid.Row="1" ColumnDefinitions="380,*" ColumnSpacing="24">
                        <!-- Formulario de Plantilla -->
                        <Border Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="16">
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding IsEditandoPlantilla, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Editar Plantilla|Nueva Plantilla'}" 
                                           FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                    <Button Text="Cancelar" Command="{Binding CancelarEdicionPlantillaCommand}" 
                                            IsVisible="{Binding IsEditandoPlantilla}"
                                            BackgroundColor="Transparent" TextColor="{StaticResource Red400}"
                                            HeightRequest="30" Padding="8,0"/>
                                </HorizontalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Nombre de la Plantilla" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding PlantillaNombre}" Placeholder="Ej: Cierre Mensual" 
                                           BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Descripción" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Editor Text="{Binding PlantillaDescripcion}" Placeholder="Descripción de la tarea..." 
                                            HeightRequest="80" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>

                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                        <Label Text="Categoría KPI" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding CategoriasKPI}" SelectedItem="{Binding PlantillaCategoriaKPI}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="Prioridad" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding Prioridades}" SelectedItem="{Binding PlantillaPrioridad}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                        <Label Text="Frecuencia" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding Frecuencias}" SelectedItem="{Binding PlantillaFrecuencia}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="Día de Ejecución" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Entry Text="{Binding PlantillaDiaEjecucion}" Keyboard="Numeric"
                                               BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                        <Label Text="Tiempo Est. (hrs)" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Entry Text="{Binding PlantillaTiempoEstimado}" Keyboard="Numeric"
                                               BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="Días Anticipación" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Entry Text="{Binding PlantillaDiasAnticipacion}" Keyboard="Numeric"
                                               BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Asignado Por Defecto" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Picker ItemsSource="{Binding Contadores}" SelectedItem="{Binding PlantillaAsignadoPorDefecto}" 
                                            ItemDisplayBinding="{Binding Name}"
                                            BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>

                                <Button Text="{Binding IsEditandoPlantilla, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Actualizar Plantilla|Crear Plantilla'}" 
                                        Command="{Binding GuardarPlantillaCommand}"
                                        BackgroundColor="{StaticResource Blue600}" TextColor="White"
                                        HeightRequest="44" CornerRadius="8"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Lista de Plantillas -->
                        <Border Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="0" StrokeShape="RoundRectangle 12" VerticalOptions="Start" MaximumHeightRequest="550">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" ColumnDefinitions="60,*,100,100,100,120" BackgroundColor="{StaticResource Gray100}" Padding="20,12">
                                    <Label Grid.Column="0" Text="FREQ" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="1" Text="PLANTILLA" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="2" Text="CATEGORÍA" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="3" Text="PRIORIDAD" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="4" Text="TIEMPO" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="5" Text="ACCIONES" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                </Grid>

                                <CollectionView Grid.Row="1" ItemsSource="{Binding Plantillas}" VerticalScrollBarVisibility="Always" HeightRequest="500">
                                    <CollectionView.EmptyView>
                                        <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="40" Spacing="12">
                                            <Border BackgroundColor="{StaticResource Gray100}" StrokeShape="RoundRectangle 30" 
                                                    HeightRequest="60" WidthRequest="60" StrokeThickness="0" HorizontalOptions="Center">
                                                <Path Data="M9 2H15L21 8V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V4C3 2.9 3.9 2 5 2H9M19 8H14V3" 
                                                      Stroke="{StaticResource Gray400Jazer}" StrokeThickness="2" WidthRequest="24" HeightRequest="24"
                                                      Aspect="Uniform" HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Border>
                                            <Label Text="No hay plantillas creadas" FontSize="16" TextColor="{StaticResource Gray500Jazer}" HorizontalOptions="Center"/>
                                            <Label Text="Crea tu primera plantilla para automatizar tareas" FontSize="12" TextColor="{StaticResource Gray400Jazer}" HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="60,*,100,100,100,120" Padding="20,12">
                                                <Label Grid.Column="0" Text="{Binding IconoFrecuencia}" FontSize="20" VerticalOptions="Center"/>
                                                
                                                <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                                    <Label Text="{Binding Nombre}" FontAttributes="Bold" TextColor="Black"/>
                                                    <Label Text="{Binding FrecuenciaTexto}" FontSize="11" TextColor="{StaticResource Gray500Jazer}"/>
                                                </VerticalStackLayout>

                                                <Border Grid.Column="2" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0" Padding="8,4" 
                                                        HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                    <Label Text="{Binding CategoriaKPI}" TextColor="{StaticResource Blue600}" FontSize="10" FontAttributes="Bold"/>
                                                </Border>

                                                <Border Grid.Column="3" BackgroundColor="{Binding ColorPrioridad}" StrokeThickness="0" Padding="8,4" 
                                                        HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                    <Label Text="{Binding Prioridad}" TextColor="White" FontSize="10" FontAttributes="Bold"/>
                                                </Border>

                                                <Label Grid.Column="4" Text="{Binding TiempoEstimadoHoras, StringFormat='{0}h'}" 
                                                       TextColor="{StaticResource Gray600Jazer}" VerticalOptions="Center" HorizontalOptions="Center"/>

                                                <HorizontalStackLayout Grid.Column="5" Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                                                    <Border BackgroundColor="{StaticResource Green50}"
                                                            HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                            ToolTipProperties.Text="Generar Tarea">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.GenerarTareaDesdePlantillaCommand}" CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" 
                                                              Stroke="{StaticResource Green600}" StrokeThickness="1.5" 
                                                              WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                    <Border BackgroundColor="{StaticResource Blue50}"
                                                            HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                            ToolTipProperties.Text="Editar">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditarPlantillaCommand}" CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" 
                                                              Stroke="{StaticResource Blue600}" StrokeThickness="1.5" 
                                                              WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                    <Border BackgroundColor="{StaticResource Red50}"
                                                            HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                            ToolTipProperties.Text="Eliminar">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EliminarPlantillaCommand}" CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" 
                                                              Stroke="{StaticResource Red400}" StrokeThickness="1.5" 
                                                              WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                </HorizontalStackLayout>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollView>

            <!-- PESTAÑA 3: ETIQUETAS -->
            <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=3}" VerticalScrollBarVisibility="Always">
                <Grid RowDefinitions="Auto,*" RowSpacing="24">
                    <VerticalStackLayout Grid.Row="0" Spacing="4">
                        <Label Text="Gestión de Etiquetas" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                        <Label Text="Crea y administra etiquetas para clasificar las tareas" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                    </VerticalStackLayout>

                    <Grid Grid.Row="1" ColumnDefinitions="350,*" ColumnSpacing="24">
                        <!-- Formulario de Etiqueta -->
                        <Border Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="16">
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding IsEditandoEtiqueta, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Editar Etiqueta|Nueva Etiqueta'}" 
                                           FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                    <Button Text="Cancelar" Command="{Binding CancelarEdicionEtiquetaCommand}" 
                                            IsVisible="{Binding IsEditandoEtiqueta}"
                                            BackgroundColor="Transparent" TextColor="{StaticResource Red400}"
                                            HeightRequest="30" Padding="8,0"/>
                                </HorizontalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Nombre de la Etiqueta" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding EtiquetaNombre}" Placeholder="Ej: Urgente, Impuestos" 
                                           BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Descripción (opcional)" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding EtiquetaDescripcion}" Placeholder="Descripción de la etiqueta..." 
                                           BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Icono" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <HorizontalStackLayout Spacing="8">
                                        <!-- Iconos para seleccionar -->
                                        <CollectionView ItemsSource="{Binding IconosEtiquetas}" SelectionMode="Single" HeightRequest="50" WidthRequest="300">
                                            <CollectionView.ItemsLayout>
                                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
                                            </CollectionView.ItemsLayout>
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Padding="8" StrokeShape="RoundRectangle 6" 
                                                            BackgroundColor="{StaticResource Gray100}" StrokeThickness="1"
                                                            Stroke="{StaticResource Gray300Jazer}"
                                                            HeightRequest="40" WidthRequest="40">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeleccionarIconoCommand}" 
                                                                                  CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="{Binding Name, Converter={StaticResource IconNameToPathConverter}}" 
                                                              Stroke="#374151" StrokeThickness="1.5"
                                                              WidthRequest="20" HeightRequest="20" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                        
                                        <!-- Indicador del icono seleccionado -->
                                        <Border BackgroundColor="{Binding EtiquetaColorHex}" StrokeThickness="0" Padding="10"
                                                StrokeShape="RoundRectangle 6" HeightRequest="44" WidthRequest="44">
                                            <Path Data="{Binding EtiquetaIcono, Converter={StaticResource IconNameToPathConverter}}" 
                                                  Stroke="White" StrokeThickness="1.5"
                                                  WidthRequest="20" HeightRequest="20" Aspect="Uniform"
                                                  HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Color" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <CollectionView ItemsSource="{Binding ColoresEtiquetas}" SelectionMode="Single" HeightRequest="50">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border WidthRequest="32" HeightRequest="32" StrokeShape="RoundRectangle 16" 
                                                        BackgroundColor="{Binding .}" StrokeThickness="2"
                                                        Stroke="{StaticResource Gray300Jazer}">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeleccionarColorCommand}" 
                                                                              CommandParameter="{Binding .}"/>
                                                    </Border.GestureRecognizers>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>

                                <!-- Preview -->
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Vista Previa" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Border BackgroundColor="{Binding EtiquetaColorHex}" StrokeThickness="0" Padding="12,6" 
                                            HorizontalOptions="Start" StrokeShape="RoundRectangle 6">
                                        <HorizontalStackLayout Spacing="6">
                                            <Path Data="{Binding EtiquetaIcono, Converter={StaticResource IconNameToPathConverter}}" 
                                                  Stroke="White" StrokeThickness="1.5"
                                                  WidthRequest="14" HeightRequest="14" Aspect="Uniform" VerticalOptions="Center"/>
                                            <Label Text="{Binding EtiquetaNombre, TargetNullValue='Nombre'}" TextColor="White" FontSize="12" FontAttributes="Bold"/>
                                        </HorizontalStackLayout>
                                    </Border>
                                </VerticalStackLayout>

                                <Button Text="{Binding IsEditandoEtiqueta, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Actualizar Etiqueta|Crear Etiqueta'}" 
                                        Command="{Binding GuardarEtiquetaCommand}"
                                        BackgroundColor="{StaticResource Blue600}" TextColor="White"
                                        HeightRequest="44" CornerRadius="8"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Lista de Etiquetas -->
                        <Border Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="0" StrokeShape="RoundRectangle 12">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" ColumnDefinitions="*,100,150" BackgroundColor="{StaticResource Gray100}" Padding="20,12">
                                    <Label Grid.Column="0" Text="ETIQUETA" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="1" Text="USOS" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="2" Text="ACCIONES" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                </Grid>

                                <CollectionView Grid.Row="1" ItemsSource="{Binding Etiquetas}" VerticalScrollBarVisibility="Always" HeightRequest="500">
                                    <CollectionView.EmptyView>
                                        <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="40" Spacing="12">
                                            <Border BackgroundColor="{StaticResource Gray100}" StrokeShape="RoundRectangle 30" 
                                                    HeightRequest="60" WidthRequest="60" StrokeThickness="0" HorizontalOptions="Center">
                                                <Path Data="M5.5 3L19.5 3C20.3 3 21 3.7 21 4.5V19.5C21 20.3 20.3 21 19.5 21H5.5C4.7 21 4 20.3 4 19.5V4.5C4 3.7 4.7 3 5.5 3M12 6L8 14H10V18L16 10H14L12 6Z" 
                                                      Stroke="{StaticResource Gray400Jazer}" StrokeThickness="2" WidthRequest="24" HeightRequest="24"
                                                      Aspect="Uniform" HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Border>
                                            <Label Text="No hay etiquetas creadas" FontSize="16" TextColor="{StaticResource Gray500Jazer}" HorizontalOptions="Center"/>
                                            <Label Text="Crea etiquetas para clasificar tus tareas" FontSize="12" TextColor="{StaticResource Gray400Jazer}" HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="*,100,150" Padding="20,12">
                                                <HorizontalStackLayout Grid.Column="0" Spacing="12" VerticalOptions="Center">
                                                    <Border BackgroundColor="{Binding ColorHex}" StrokeThickness="0" Padding="10,6" StrokeShape="RoundRectangle 6">
                                                        <HorizontalStackLayout Spacing="6">
                                                            <Path Data="{Binding Icono, Converter={StaticResource IconNameToPathConverter}}" 
                                                                  Stroke="White" StrokeThickness="1.5"
                                                                  WidthRequest="14" HeightRequest="14" Aspect="Uniform" VerticalOptions="Center"/>
                                                            <Label Text="{Binding Nombre}" TextColor="White" FontSize="12" FontAttributes="Bold"/>
                                                        </HorizontalStackLayout>
                                                    </Border>
                                                    <Label Text="{Binding Descripcion}" TextColor="{StaticResource Gray500Jazer}" FontSize="12" VerticalOptions="Center"/>
                                                </HorizontalStackLayout>

                                                <Border Grid.Column="1" BackgroundColor="{StaticResource Gray100}" StrokeThickness="0" Padding="12,4" 
                                                        HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 12">
                                                    <Label Text="{Binding TotalUsos, StringFormat='{0} tareas'}" TextColor="{StaticResource Gray600Jazer}" FontSize="11"/>
                                                </Border>

                                                <HorizontalStackLayout Grid.Column="2" Spacing="8" HorizontalOptions="Center" VerticalOptions="Center">
                                                    <Border BackgroundColor="{StaticResource Blue50}"
                                                            HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                            ToolTipProperties.Text="Editar">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditarEtiquetaCommand}" CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" 
                                                              Stroke="{StaticResource Blue600}" StrokeThickness="1.5" 
                                                              WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                    <Border BackgroundColor="{StaticResource Red50}"
                                                            HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                            ToolTipProperties.Text="Eliminar">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EliminarEtiquetaCommand}" CommandParameter="{Binding .}"/>
                                                        </Border.GestureRecognizers>
                                                        <Path Data="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" 
                                                              Stroke="{StaticResource Red400}" StrokeThickness="1.5" 
                                                              WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                              HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    </Border>
                                                </HorizontalStackLayout>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollView>

            <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=4}" VerticalScrollBarVisibility="Always">
                <Grid RowDefinitions="Auto,*" RowSpacing="24">
                    <VerticalStackLayout Grid.Row="0" Spacing="4">
                         <Label Text="Centro de Mensajes" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                         <Label Text="Comunicaciones internas con el equipo" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                    </VerticalStackLayout>
    
                    <Grid Grid.Row="1" ColumnDefinitions="340,*" ColumnSpacing="24">
                     
                        <VerticalStackLayout Grid.Column="0" Spacing="20">
                            
                            <!-- Difusión General - Mejorada -->
                            <Border BackgroundColor="White" Stroke="{StaticResource Purple200}" Padding="0" StrokeShape="RoundRectangle 16">
                                <Grid RowDefinitions="Auto,*">
                                    <Border Grid.Row="0" BackgroundColor="{StaticResource Purple50}" Padding="16" StrokeThickness="0">
                                        <HorizontalStackLayout Spacing="10">
                                            <Border BackgroundColor="{StaticResource Purple500}" StrokeShape="RoundRectangle 20" 
                                                    HeightRequest="40" WidthRequest="40" StrokeThickness="0">
                                                <Path Data="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46" 
                                                      Stroke="White" StrokeThickness="1.5" 
                                                      WidthRequest="20" HeightRequest="20" Aspect="Uniform"
                                                      HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Border>
                                            <VerticalStackLayout VerticalOptions="Center">
                                                <Label Text="Difusión General" FontAttributes="Bold" TextColor="{StaticResource Purple700}" FontSize="15"/>
                                                <Label Text="Enviar a todo el equipo" TextColor="{StaticResource Purple500}" FontSize="11"/>
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                    </Border>
                                    <VerticalStackLayout Grid.Row="1" Spacing="12" Padding="16">
                                        <Border Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 12" BackgroundColor="{StaticResource Gray50}" Padding="12">
                                            <Editor Text="{Binding MensajeBroadcastContent}" 
                                                    Placeholder="Escribe un mensaje para todo el equipo..." 
                                                    PlaceholderColor="{StaticResource Gray400Jazer}"
                                                    HeightRequest="80" BackgroundColor="Transparent" 
                                                    TextColor="{StaticResource Gray900Jazer}"/>
                                        </Border>
                                        <Button Text="Enviar a Todos" Command="{Binding EnviarBroadcastCommand}" 
                                                BackgroundColor="{StaticResource Purple600}" TextColor="White"
                                                HeightRequest="44" CornerRadius="10" FontAttributes="Bold"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
    
                            <!-- Mensaje Directo - Mejorado -->
                            <Border BackgroundColor="White" Stroke="{StaticResource Blue200}" Padding="0" StrokeShape="RoundRectangle 16">
                                <Grid RowDefinitions="Auto,*">
                                    <Border Grid.Row="0" BackgroundColor="{StaticResource Blue50}" Padding="16" StrokeThickness="0">
                                        <HorizontalStackLayout Spacing="10">
                                            <Border BackgroundColor="{StaticResource Blue500}" StrokeShape="RoundRectangle 20" 
                                                    HeightRequest="40" WidthRequest="40" StrokeThickness="0">
                                                <Path Data="M2 6C2 4.89543 2.89543 4 4 4H20C21.1046 4 22 4.89543 22 6V18C22 19.1046 21.1046 20 20 20H6L2 24V6Z" 
                                                      Fill="White" WidthRequest="18" HeightRequest="18"
                                                      Aspect="Uniform" HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Border>
                                            <VerticalStackLayout VerticalOptions="Center">
                                                <Label Text="Mensaje Directo" FontAttributes="Bold" TextColor="{StaticResource Blue700}" FontSize="15"/>
                                                <Label Text="Comunicación privada" TextColor="{StaticResource Blue500}" FontSize="11"/>
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                    </Border>
                                    <VerticalStackLayout Grid.Row="1" Spacing="12" Padding="16">
                                        <VerticalStackLayout Spacing="4">
                                            <Label Text="Destinatario" FontSize="11" TextColor="{StaticResource Gray500Jazer}" FontAttributes="Bold"/>
                                            <Border Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 10" BackgroundColor="{StaticResource Gray50}" Padding="4">
                                                <Picker Title="Seleccionar contador..." 
                                                        ItemsSource="{Binding Contadores}" 
                                                        SelectedItem="{Binding DestinatarioMensaje}" 
                                                        ItemDisplayBinding="{Binding Username}" 
                                                        TextColor="{StaticResource Gray900Jazer}" 
                                                        BackgroundColor="Transparent"/>
                                            </Border>
                                        </VerticalStackLayout>
                                        <Border Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 12" BackgroundColor="{StaticResource Gray50}" Padding="12">
                                            <Editor Text="{Binding MensajeIndividualContent}" 
                                                    Placeholder="Escribe tu mensaje privado..." 
                                                    PlaceholderColor="{StaticResource Gray400Jazer}"
                                                    HeightRequest="80" BackgroundColor="Transparent" 
                                                    TextColor="{StaticResource Gray900Jazer}"/>
                                        </Border>
                                        <Button Text="Enviar Mensaje" Command="{Binding EnviarMensajeIndividualCommand}" 
                                                BackgroundColor="{StaticResource Blue600}" TextColor="White"
                                                HeightRequest="44" CornerRadius="10" FontAttributes="Bold"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </VerticalStackLayout>
    
                        <!-- Historial de Mensajes - Mejorado estilo Chat -->
                        <Border Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="0" StrokeShape="RoundRectangle 16">
                            <Grid RowDefinitions="Auto,*">
                                <!-- Header del chat -->
                                <Border Grid.Row="0" BackgroundColor="{StaticResource Gray50}" Padding="20,16" StrokeThickness="0">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <HorizontalStackLayout Spacing="12">
                                            <Border BackgroundColor="{StaticResource Green500}" StrokeShape="RoundRectangle 16" 
                                                    HeightRequest="32" WidthRequest="32" StrokeThickness="0">
                                                <Path Data="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 0 1 .865-.501 48.172 48.172 0 0 0 3.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" 
                                                      Stroke="White" StrokeThickness="1.5" 
                                                      WidthRequest="16" HeightRequest="16" Aspect="Uniform"
                                                      HorizontalOptions="Center" VerticalOptions="Center"/>
                                            </Border>
                                            <VerticalStackLayout VerticalOptions="Center">
                                                <Label Text="Historial de Comunicaciones" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}" FontSize="15"/>
                                                <Label Text="{Binding Mensajes.Count, StringFormat='{0} mensajes'}" TextColor="{StaticResource Gray500Jazer}" FontSize="11"/>
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                        <Border Grid.Column="1" BackgroundColor="{StaticResource Gray100}" 
                                                HeightRequest="36" WidthRequest="36" StrokeThickness="0" StrokeShape="RoundRectangle 18"
                                                ToolTipProperties.Text="Actualizar">
                                            <Path Data="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" 
                                                  Stroke="{StaticResource Gray600Jazer}" StrokeThickness="1.5" 
                                                  WidthRequest="16" HeightRequest="16" Aspect="Uniform"
                                                  HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>
                                    </Grid>
                                </Border>
                                
                                <!-- Lista de mensajes estilo chat -->
                                <CollectionView Grid.Row="1" ItemsSource="{Binding Mensajes}" 
                                                VerticalScrollBarVisibility="Always" 
                                                ItemsUpdatingScrollMode="KeepLastItemInView"
                                                Margin="12">
                                    <CollectionView.EmptyView>
                                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12" Padding="40">
                                            <Border BackgroundColor="{StaticResource Gray100}" StrokeShape="RoundRectangle 40" 
                                                    HeightRequest="80" WidthRequest="80" StrokeThickness="0" HorizontalOptions="Center">
                                                <Path Data="M2 6C2 4.89543 2.89543 4 4 4H20C21.1046 4 22 4.89543 22 6V18C22 19.1046 21.1046 20 20 20H6L2 24V6Z" 
                                                      Fill="{StaticResource Gray400Jazer}" WidthRequest="32" HeightRequest="32"
                                                      Aspect="Uniform"/>
                                            </Border>
                                            <Label Text="Sin mensajes" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource Gray500Jazer}" HorizontalOptions="Center"/>
                                            <Label Text="Envía el primer mensaje al equipo" FontSize="13" TextColor="{StaticResource Gray400Jazer}" HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <VerticalStackLayout>
                                                <!-- Separador de fecha -->
                                                <HorizontalStackLayout Spacing="12" HorizontalOptions="Center" Margin="0,16,0,8"
                                                                       IsVisible="{Binding EsPrimerMensajeDelDia}">
                                                    <BoxView HeightRequest="1" WidthRequest="60" Color="{StaticResource Gray200Jazer}" VerticalOptions="Center"/>
                                                    <Border Padding="12,6" StrokeShape="RoundRectangle 12" BackgroundColor="{StaticResource Gray100}" StrokeThickness="0">
                                                        <Label Text="{Binding FechaAgrupacion}" FontSize="11" FontAttributes="Bold" 
                                                               TextColor="{StaticResource Gray500Jazer}"/>
                                                    </Border>
                                                    <BoxView HeightRequest="1" WidthRequest="60" Color="{StaticResource Gray200Jazer}" VerticalOptions="Center"/>
                                                </HorizontalStackLayout>
                                                
                                                <!-- Tarjeta de mensaje -->
                                                <Border Margin="4,6" Padding="14,10" StrokeShape="RoundRectangle 14" StrokeThickness="0">
                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border" Binding="{Binding Para}" Value="todos">
                                                            <Setter Property="BackgroundColor" Value="{StaticResource Purple50}"/>
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="BackgroundColor" Value="{StaticResource Gray50}"/>
                                                        </Style>
                                                    </Border.Style>
                                                    <Grid ColumnDefinitions="44,*,Auto" ColumnSpacing="12">
                                                        <!-- Avatar -->
                                                        <Border Grid.Column="0" StrokeShape="RoundRectangle 22" 
                                                                HeightRequest="44" WidthRequest="44" StrokeThickness="0"
                                                                VerticalOptions="Start">
                                                            <Border.Triggers>
                                                                <DataTrigger TargetType="Border" Binding="{Binding De}" Value="admin">
                                                                    <Setter Property="BackgroundColor" Value="{StaticResource Blue500}"/>
                                                                </DataTrigger>
                                                            </Border.Triggers>
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="BackgroundColor" Value="{StaticResource Green500}"/>
                                                                </Style>
                                                            </Border.Style>
                                                            <Label Text="{Binding DeNombre, Converter={StaticResource StringToInitialsConverter}}" 
                                                                   TextColor="White" FontSize="14" FontAttributes="Bold"
                                                                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                                        </Border>
                                                        
                                                        <!-- Contenido del mensaje -->
                                                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                                                            <HorizontalStackLayout Spacing="8">
                                                                <Label Text="{Binding DeNombre}" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}" FontSize="13"/>
                                                                <Path Data="M5 12L9 12L9 12L13 12" Stroke="{StaticResource Gray400Jazer}" StrokeThickness="1.5" 
                                                                      HeightRequest="8" WidthRequest="12" Aspect="Uniform" VerticalOptions="Center"/>
                                                                <Border Padding="6,2" StrokeShape="RoundRectangle 8" StrokeThickness="0">
                                                                    <Border.Triggers>
                                                                        <DataTrigger TargetType="Border" Binding="{Binding Para}" Value="todos">
                                                                            <Setter Property="BackgroundColor" Value="{StaticResource Purple100}"/>
                                                                        </DataTrigger>
                                                                    </Border.Triggers>
                                                                    <Border.Style>
                                                                        <Style TargetType="Border">
                                                                            <Setter Property="BackgroundColor" Value="{StaticResource Blue100}"/>
                                                                        </Style>
                                                                    </Border.Style>
                                                                    <Label Text="{Binding ParaNombre}" FontSize="11" FontAttributes="Bold">
                                                                        <Label.Triggers>
                                                                            <DataTrigger TargetType="Label" Binding="{Binding Para}" Value="todos">
                                                                                <Setter Property="TextColor" Value="{StaticResource Purple700}"/>
                                                                            </DataTrigger>
                                                                        </Label.Triggers>
                                                                        <Label.Style>
                                                                            <Style TargetType="Label">
                                                                                <Setter Property="TextColor" Value="{StaticResource Blue700}"/>
                                                                            </Style>
                                                                        </Label.Style>
                                                                    </Label>
                                                                </Border>
                                                            </HorizontalStackLayout>
                                                            <Label Text="{Binding Contenido}" TextColor="{StaticResource Gray700Jazer}" 
                                                                   FontSize="14" LineBreakMode="WordWrap"/>
                                                        </VerticalStackLayout>
                                                        
                                                        <!-- Timestamp -->
                                                        <Label Grid.Column="2" Text="{Binding MarcaTiempo, StringFormat='{0:HH:mm}'}" 
                                                               TextColor="{StaticResource Gray400Jazer}" FontSize="11" 
                                                               VerticalOptions="Start"/>
                                                    </Grid>
                                                </Border>
                                            </VerticalStackLayout>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollView>

            <Grid IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=5}">
                <ScrollView VerticalScrollBarVisibility="Always">
                    <VerticalStackLayout Spacing="24">
                        
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Rendimiento del Equipo" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}"/>
                            <HorizontalStackLayout Grid.Column="1" Spacing="8">
                                <Label Text="Fecha Reporte:" VerticalOptions="Center" TextColor="{StaticResource Gray700Jazer}"/>
                                <DatePicker Date="{Binding FechaReporte}" TextColor="{StaticResource Gray900Jazer}" BackgroundColor="White"/>
                                <Border BackgroundColor="{StaticResource Gray100Jazer}" 
                                        HeightRequest="36" WidthRequest="40" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                        ToolTipProperties.Text="Actualizar Datos">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding RefreshCommand}"/>
                                    </Border.GestureRecognizers>
                                    <Path Data="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" 
                                          Stroke="{StaticResource Gray900Jazer}" StrokeThickness="1.5" 
                                          WidthRequest="18" HeightRequest="18" Aspect="Uniform"
                                          HorizontalOptions="Center" VerticalOptions="Center"/>
                                </Border>
                            </HorizontalStackLayout>
                        </Grid>

                        <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="0">
                            <VerticalStackLayout>
                                <Label Text="Cumplimiento Mensual (Acumulado al Día)" FontAttributes="Bold" TextColor="{StaticResource Gray900Jazer}" Margin="20,16,20,8"/>
                                <Grid RowDefinitions="Auto,*" Margin="0,0,0,16">
                                    <CollectionView ItemsSource="{Binding ReportesKPI}" VerticalScrollBarVisibility="Always" HeightRequest="300">
                                        <CollectionView.Header>
                                             <Grid ColumnDefinitions="2*,*,*,*" Padding="20,8" BackgroundColor="{StaticResource Gray100}">
                                                 <Label Grid.Column="0" Text="CATEGORÍA" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                                 <Label Grid.Column="1" Text="TOTAL MES" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                                 <Label Grid.Column="2" Text="HECHO (ACUM)" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                                 <Label Grid.Column="3" Text="%" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                             </Grid>
                                        </CollectionView.Header>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <VerticalStackLayout Spacing="0">
                                                    <Grid ColumnDefinitions="2*,*,*,*" Padding="20,12,20,4">
                                                        <Label Grid.Column="0" Text="{Binding Categoria}" FontAttributes="Bold" TextColor="Black"/>
                                                        <Label Grid.Column="1" Text="{Binding TotalTareas}" HorizontalOptions="Center" TextColor="Black"/>
                                                        <Label Grid.Column="2" Text="{Binding Completadas}" HorizontalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                        <Border Grid.Column="3" BackgroundColor="{Binding ColorEstado}" Padding="8,2" StrokeThickness="0" StrokeShape="RoundRectangle 4" HorizontalOptions="Center">
                                                            <Label Text="{Binding PorcentajeTexto}" TextColor="White" FontAttributes="Bold" FontSize="12"/>
                                                        </Border>
                                                    </Grid>
                                                    <ProgressBar Progress="{Binding Porcentaje}" ProgressColor="{Binding ColorEstado}" HeightRequest="4" Margin="20,0,20,12" BackgroundColor="{StaticResource Gray50}"/>
                                                    <BoxView HeightRequest="1" Color="{StaticResource Gray100Jazer}"/>
                                                </VerticalStackLayout>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </VerticalStackLayout>
                        </Border>

                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="16">
                
                            <Border Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="16">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="Mejor Rendimiento" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                                    <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                        <Path Data="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" 
                                              Stroke="{StaticResource Yellow600}" StrokeThickness="1.5" 
                                              WidthRequest="24" HeightRequest="24" Aspect="Uniform" VerticalOptions="Center"/>
                                        <VerticalStackLayout>
                                            <Label Text="{Binding MejorContadorNombre}" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue600}"/>
                                            <Label Text="{Binding MejorContadorEficiencia, StringFormat='Eficiencia: {0}'}" FontSize="10" TextColor="{StaticResource Green600}"/>
                                        </VerticalStackLayout>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                            
                            <Border Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="16">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="Eficiencia Promedio" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                                    <Label Text="{Binding PromedioEficiencia}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Purple600}"/>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Column="2" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="16">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="Total Horas Invertidas" FontSize="12" TextColor="{StaticResource Gray500Jazer}"/>
                                    <Label Text="{Binding TotalHorasEquipo}" FontSize="24" FontAttributes="Bold" TextColor="{StaticResource Blue500}"/>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="24">
                            <VerticalStackLayout Spacing="16">
                                <Label Text="Comparativa de Eficiencia" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                                
                                <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Default">
                                    <StackLayout BindableLayout.ItemsSource="{Binding ReportesDetallados}" 
                                                 Orientation="Horizontal" 
                                                 Spacing="24"
                                                 HeightRequest="200"
                                                 VerticalOptions="End">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate>
                                                <VerticalStackLayout Spacing="8" VerticalOptions="End">
                                                    <Label Text="{Binding EficienciaTexto}" FontSize="10" HorizontalOptions="Center" TextColor="Black"/>
                                                    <BoxView Color="{Binding ColorEstado}" WidthRequest="40" HeightRequest="{Binding BarHeight}" CornerRadius="4,4,0,0" HorizontalOptions="Center"/>
                                                    <Label Text="{Binding Nombre}" FontSize="10" HorizontalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                </VerticalStackLayout>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </StackLayout>
                                </ScrollView>
                            </VerticalStackLayout>
                        </Border>
                        
                        <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 8" Padding="0">
                            <Grid RowDefinitions="Auto,*">
             
                                <Grid Grid.Row="0" ColumnDefinitions="2*,*,*,*,*" BackgroundColor="{StaticResource Gray100}" Padding="20,12">
                                    <Label Grid.Column="0" Text="CONTADOR" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="1" Text="TOTAL" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="2" Text="HECHO" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="3" Text="PENDIENTE" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="4" Text="TIEMPO SESIÓN" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                </Grid>
                                
                                <CollectionView Grid.Row="1" ItemsSource="{Binding ReportesDetallados}" VerticalScrollBarVisibility="Always" HeightRequest="400">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="2*,*,*,*,*" Padding="20,16">
                                                <HorizontalStackLayout Grid.Column="0" Spacing="10">
                                                    <Border HeightRequest="24" WidthRequest="24" StrokeShape="RoundRectangle 12" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0">
                                                        <Grid>
                                                            <Label Text="{Binding Nombre, Converter={StaticResource StringToInitialsConverter}}" FontSize="9" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource Blue600}" FontAttributes="Bold"/>
                                                            <Image Source="{Binding Contador.FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                                                   Aspect="AspectFill"
                                                                   IsVisible="{Binding Contador.FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                        </Grid>
                                                    </Border>
                                                    <Label Text="{Binding Nombre}" VerticalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                </HorizontalStackLayout>
                                                
                                                <Label Grid.Column="1" Text="{Binding TotalTareas}" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                <Label Grid.Column="2" Text="{Binding Completadas}" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource Green600}" FontAttributes="Bold"/>
                                                <Label Grid.Column="3" Text="{Binding Pendientes}" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource Yellow600}" FontAttributes="Bold"/>
                                                
                                                <HorizontalStackLayout Grid.Column="4" Spacing="4" HorizontalOptions="Center" VerticalOptions="Center">
                                                    <Label Text="{Binding Eficiencia}" TextColor="{StaticResource Purple600}" FontSize="12" FontAttributes="Bold"/>
                                                </HorizontalStackLayout>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>

                    </VerticalStackLayout>
                </ScrollView>
            </Grid>

            <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=6}" VerticalScrollBarVisibility="Always">
                <Grid RowDefinitions="Auto,*" RowSpacing="24">
                    <VerticalStackLayout Grid.Row="0" Spacing="4">
                         <Label Text="Gestión de Usuarios" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Gray800Jazer}"/>
                         <Label Text="Crear, editar y eliminar usuarios del sistema" TextColor="{StaticResource Gray500Jazer}" FontSize="14"/>
                    </VerticalStackLayout>
    
                    <Grid x:Name="UsersGrid" Grid.Row="1" ColumnDefinitions="350,*" ColumnSpacing="24">
               
                        <Border x:Name="FormUserBorder" Grid.Column="0" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="20" StrokeShape="RoundRectangle 12" VerticalOptions="Start">
                            <VerticalStackLayout Spacing="16">
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding IsEditMode, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Editar Usuario|Nuevo Usuario'}" 
                                           FontSize="16" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                    <Button Text="Cancelar" Command="{Binding CancelarEdicionCommand}" 
                                            IsVisible="{Binding IsEditMode}"
                                            BackgroundColor="Transparent" TextColor="{StaticResource Red400}"
                                            HeightRequest="30" Padding="8,0"/>
                                </HorizontalStackLayout>
                                
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Nombre Completo" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevoUsuarioNombre}" Placeholder="Ej: María García" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>
    
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Usuario (Login)" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevoUsuarioUsername}" Placeholder="Ej: maria" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>
    
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Contraseña" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                    <Entry Text="{Binding NuevoUsuarioPassword}" Placeholder="Nueva contraseña" IsPassword="True" BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                </VerticalStackLayout>
    
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Rol" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding Roles}" SelectedItem="{Binding NuevoUsuarioRol}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="Área" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                        <Picker ItemsSource="{Binding Areas}" SelectedItem="{Binding NuevoUsuarioArea}" 
                                                BackgroundColor="{StaticResource Gray50}" TextColor="Black"/>
                                    </VerticalStackLayout>
                                </Grid>
    
                                <Button Text="{Binding IsEditMode, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Guardar Cambios|Crear Usuario'}" 
                                        Command="{Binding GuardarUsuarioCommand}" 
                                        BackgroundColor="{StaticResource Blue600}" TextColor="White" FontAttributes="Bold" 
                                        CornerRadius="8" HeightRequest="45" Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </Border>
    
                        <Border x:Name="ListUserBorder" Grid.Column="1" BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" Padding="0" StrokeShape="RoundRectangle 12" VerticalOptions="Start" MaximumHeightRequest="550">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" ColumnDefinitions="60,*,100,80,100,130" BackgroundColor="{StaticResource Gray100}" Padding="16,12">
                                    <Label Grid.Column="0" Text="FOTO" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="1" Text="NOMBRE" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="2" Text="USUARIO" FontSize="11" FontAttributes="Bold" TextColor="Black"/>
                                    <Label Grid.Column="3" Text="ROL" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="4" Text="ÁREA" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                    <Label Grid.Column="5" Text="ACCIONES" FontSize="11" FontAttributes="Bold" TextColor="Black" HorizontalOptions="Center"/>
                                </Grid>
                                <CollectionView Grid.Row="1" ItemsSource="{Binding TodosLosUsuarios}" VerticalScrollBarVisibility="Always">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="60,*,100,80,100,130" Padding="16,10">
                                                      
                                                        <Border Grid.Column="0" HeightRequest="40" WidthRequest="40" StrokeShape="RoundRectangle 20" 
                                                                BackgroundColor="{StaticResource Blue50}" StrokeThickness="0">
                                                            <Grid>
                                                                <Label Text="{Binding Name, Converter={StaticResource StringToInitialsConverter}}" 
                                                                       FontSize="14" FontAttributes="Bold" TextColor="{StaticResource Blue600}"
                                                                       HorizontalOptions="Center" VerticalOptions="Center"/>
                                                                
                                                                <Image Source="{Binding FotoPerfil, Converter={StaticResource FileToImageSourceConverter}}" 
                                                                       Aspect="AspectFill"
                                                                       IsVisible="{Binding FotoPerfil, Converter={StaticResource StringNotEmptyConverter}}"/>
                                                            </Grid>
                                                        </Border>
                                                        
                                                        <Label Grid.Column="1" Text="{Binding Name}" VerticalOptions="Center" TextColor="Black" FontAttributes="Bold"/>
                                                        <Label Grid.Column="2" Text="{Binding Username}" VerticalOptions="Center" TextColor="{StaticResource Gray600Jazer}"/>
                                                        
                                                        <Border Grid.Column="3" BackgroundColor="{StaticResource Blue50}" StrokeThickness="0" Padding="8,4" 
                                                                HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 4">
                                                            <Label Text="{Binding Role}" TextColor="{StaticResource Blue600}" FontSize="11" FontAttributes="Bold"/>
                                                        </Border>
                                                        
                                                        <Label Grid.Column="4" Text="{Binding Area}" VerticalOptions="Center" TextColor="{StaticResource Gray600Jazer}" HorizontalOptions="Center"/>
                                                        
                                                        <HorizontalStackLayout Grid.Column="5" Spacing="8" HorizontalOptions="Center" VerticalOptions="Center">
                                                            <Border BackgroundColor="{StaticResource Gray100Jazer}"
                                                                    HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                                    ToolTipProperties.Text="Cambiar Foto">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeleccionarFotoCommand}" CommandParameter="{Binding .}"/>
                                                                </Border.GestureRecognizers>
                                                                <Path Data="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" 
                                                                      Stroke="{StaticResource Gray700Jazer}" StrokeThickness="1.5" 
                                                                      WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                                      HorizontalOptions="Center" VerticalOptions="Center"/>
                                                            </Border>
                                                            <Border BackgroundColor="{StaticResource Blue50}"
                                                                    HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                                    ToolTipProperties.Text="Editar">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IniciarEdicionCommand}" CommandParameter="{Binding .}"/>
                                                                </Border.GestureRecognizers>
                                                                <Path Data="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" 
                                                                      Stroke="{StaticResource Blue600}" StrokeThickness="1.5" 
                                                                      WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                                      HorizontalOptions="Center" VerticalOptions="Center"/>
                                                            </Border>
                                                            <Border BackgroundColor="{StaticResource Red50}"
                                                                    HeightRequest="32" WidthRequest="32" StrokeThickness="0" StrokeShape="RoundRectangle 6"
                                                                    ToolTipProperties.Text="Eliminar">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EliminarUsuarioCommand}" CommandParameter="{Binding .}"/>
                                                                </Border.GestureRecognizers>
                                                                <Path Data="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" 
                                                                      Stroke="{StaticResource Red400}" StrokeThickness="1.5" 
                                                                      WidthRequest="14" HeightRequest="14" Aspect="Uniform"
                                                                      HorizontalOptions="Center" VerticalOptions="Center"/>
                                                            </Border>
                                                        </HorizontalStackLayout>
                                                    </Grid>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollView>

            <!-- PESTAÑA 7: DOCUMENTOS - PRÓXIMAMENTE -->
            <Grid IsVisible="{Binding SelectedTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=7}"
                  HorizontalOptions="Fill" VerticalOptions="Fill">
                <Border BackgroundColor="White" Stroke="{StaticResource Gray200Jazer}" StrokeShape="RoundRectangle 16" 
                        Padding="40" HorizontalOptions="Center" VerticalOptions="Center" MaximumWidthRequest="500">
                    <VerticalStackLayout Spacing="24" HorizontalOptions="Center">
                        <!-- Icono de documento -->
                        <Border HeightRequest="100" WidthRequest="100" StrokeShape="RoundRectangle 50" 
                                BackgroundColor="{StaticResource Blue50}" StrokeThickness="0" HorizontalOptions="Center">
                            <Path Data="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" 
                                  Stroke="{StaticResource Blue500}" StrokeThickness="3" 
                                  WidthRequest="48" HeightRequest="48" Aspect="Uniform"
                                  HorizontalOptions="Center" VerticalOptions="Center"/>
                        </Border>
                        
                        <!-- Título -->
                        <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                            <Label Text="Gestión de Documentos" FontSize="24" FontAttributes="Bold" 
                                   TextColor="{StaticResource Gray900Jazer}" HorizontalOptions="Center"/>
                            <Label Text="Módulo en desarrollo" FontSize="16" 
                                   TextColor="{StaticResource Blue600}" HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                        
                        <!-- Descripción -->
                        <Label Text="Próximamente podrás gestionar documentos, archivos y recursos compartidos con tu equipo de contadores desde este módulo."
                               FontSize="14" TextColor="{StaticResource Gray500Jazer}" 
                               HorizontalTextAlignment="Center" MaximumWidthRequest="400"/>
                        
                        <!-- Badge de próximamente -->
                        <Border BackgroundColor="{StaticResource Yellow100}" Stroke="{StaticResource Yellow400}" 
                                StrokeShape="RoundRectangle 20" Padding="16,10" HorizontalOptions="Center">
                            <HorizontalStackLayout Spacing="8">
                                <Path Data="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" 
                                      Stroke="{StaticResource Yellow700}" StrokeThickness="2" 
                                      WidthRequest="20" HeightRequest="20" Aspect="Uniform" VerticalOptions="Center"/>
                                <Label Text="Próximamente disponible" FontSize="14" FontAttributes="Bold" 
                                       TextColor="{StaticResource Yellow700}" VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!-- Features que vendrán -->
                        <Border BackgroundColor="{StaticResource Gray50}" StrokeThickness="0" 
                                StrokeShape="RoundRectangle 12" Padding="20">
                            <VerticalStackLayout Spacing="12">
                                <Label Text="Funcionalidades planeadas:" FontSize="13" FontAttributes="Bold" TextColor="{StaticResource Gray700Jazer}"/>
                                <HorizontalStackLayout Spacing="8">
                                    <Path Data="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" 
                                          Stroke="{StaticResource Green500}" StrokeThickness="1.5" 
                                          WidthRequest="16" HeightRequest="16" Aspect="Uniform"/>
                                    <Label Text="Subir y organizar documentos" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="8">
                                    <Path Data="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" 
                                          Stroke="{StaticResource Green500}" StrokeThickness="1.5" 
                                          WidthRequest="16" HeightRequest="16" Aspect="Uniform"/>
                                    <Label Text="Compartir archivos con el equipo" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="8">
                                    <Path Data="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" 
                                          Stroke="{StaticResource Green500}" StrokeThickness="1.5" 
                                          WidthRequest="16" HeightRequest="16" Aspect="Uniform"/>
                                    <Label Text="Vincular documentos a tareas" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="8">
                                    <Path Data="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" 
                                          Stroke="{StaticResource Green500}" StrokeThickness="1.5" 
                                          WidthRequest="16" HeightRequest="16" Aspect="Uniform"/>
                                    <Label Text="Control de versiones" FontSize="12" TextColor="{StaticResource Gray600Jazer}"/>
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </Border>
            </Grid>

        </Grid>

        <!-- PANEL MODAL DE ETIQUETAS PARA TAREA -->
        <Grid Grid.RowSpan="4" IsVisible="{Binding TareaParaEtiquetas, Converter={StaticResource IsNotNullConverter}}" 
              BackgroundColor="#80000000" ZIndex="999" InputTransparent="False">
            <Border HorizontalOptions="Center" VerticalOptions="Center" BackgroundColor="White" StrokeShape="RoundRectangle 20" 
                    Stroke="{StaticResource Gray200Jazer}" Padding="0" WidthRequest="500" HeightRequest="500">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- Header -->
                    <Border Grid.Row="0" BackgroundColor="{StaticResource Blue50}" Padding="24,20" StrokeThickness="0">
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Spacing="4">
                                <HorizontalStackLayout Spacing="10">
                                    <Path Data="M5.5 3L19.5 3C20.3 3 21 3.7 21 4.5V19.5C21 20.3 20.3 21 19.5 21H5.5C4.7 21 4 20.3 4 19.5V4.5C4 3.7 4.7 3 5.5 3M12 6L8 14H10V18L16 10H14L12 6Z" 
                                          Fill="{StaticResource Blue700}" WidthRequest="20" HeightRequest="20"
                                          Aspect="Uniform" VerticalOptions="Center"/>
                                    <Label Text="Asignar Etiquetas" FontSize="20" FontAttributes="Bold" TextColor="{StaticResource Blue700}"/>
                                </HorizontalStackLayout>
                                <Label Text="{Binding TareaParaEtiquetas.Titulo}" FontSize="14" TextColor="{StaticResource Gray600Jazer}" LineBreakMode="TailTruncation"/>
                            </VerticalStackLayout>
                            <Border Grid.Column="1" 
                                    BackgroundColor="Transparent"
                                    HeightRequest="44" WidthRequest="44">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding CerrarPanelEtiquetasCommand}"/>
                                </Border.GestureRecognizers>
                                <Path Data="M6 18 18 6M6 6l12 12" 
                                      Stroke="{StaticResource Gray500Jazer}" StrokeThickness="2" 
                                      WidthRequest="18" HeightRequest="18" Aspect="Uniform"
                                      HorizontalOptions="Center" VerticalOptions="Center"/>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Lista de etiquetas -->
                    <ScrollView Grid.Row="1" Margin="24,16">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Selecciona las etiquetas para esta tarea:" FontSize="13" TextColor="{StaticResource Gray500Jazer}" Margin="0,0,0,8"/>
                            <CollectionView ItemsSource="{Binding Etiquetas}" HeightRequest="280" SelectionMode="None">
                                <CollectionView.EmptyView>
                                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="12" Padding="20">
                                        <Border BackgroundColor="{StaticResource Gray100}" StrokeShape="RoundRectangle 25" 
                                                HeightRequest="50" WidthRequest="50" StrokeThickness="0" HorizontalOptions="Center">
                                            <Path Data="M5.5 3L19.5 3C20.3 3 21 3.7 21 4.5V19.5C21 20.3 20.3 21 19.5 21H5.5C4.7 21 4 20.3 4 19.5V4.5C4 3.7 4.7 3 5.5 3M12 6L8 14H10V18L16 10H14L12 6Z" 
                                                  Stroke="{StaticResource Gray400Jazer}" StrokeThickness="1.5" WidthRequest="20" HeightRequest="20"
                                                  Aspect="Uniform" HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>
                                        <Label Text="No hay etiquetas creadas" TextColor="{StaticResource Gray400Jazer}" HorizontalOptions="Center"/>
                                        <Label Text="Ve a la pestaña Etiquetas para crear algunas" TextColor="{StaticResource Gray400Jazer}" FontSize="12" HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                </CollectionView.EmptyView>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="0,4" Padding="12,10" StrokeShape="RoundRectangle 10"
                                                Stroke="{StaticResource Gray200Jazer}">
                                            <Border.Triggers>
                                                <DataTrigger TargetType="Border" Binding="{Binding EstaSeleccionada}" Value="True">
                                                    <Setter Property="BackgroundColor" Value="{StaticResource Blue50}"/>
                                                    <Setter Property="Stroke" Value="{StaticResource Blue400}"/>
                                                </DataTrigger>
                                            </Border.Triggers>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={x:Reference MainGrid}, Path=BindingContext.ToggleEtiquetaEnTareaCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                <!-- Etiqueta visual -->
                                                <Border Grid.Column="0" BackgroundColor="{Binding ColorHex}" 
                                                        StrokeThickness="0" Padding="10,6" StrokeShape="RoundRectangle 8">
                                                    <HorizontalStackLayout Spacing="6">
                                                        <Path Data="{Binding Icono, Converter={StaticResource IconNameToPathConverter}}" 
                                                              Stroke="White" StrokeThickness="1.5"
                                                              WidthRequest="14" HeightRequest="14" Aspect="Uniform" VerticalOptions="Center"/>
                                                        <Label Text="{Binding Nombre}" TextColor="White" FontSize="12" FontAttributes="Bold"/>
                                                    </HorizontalStackLayout>
                                                </Border>
                                                
                                                <!-- Descripción -->
                                                <Label Grid.Column="1" Text="{Binding Descripcion}" 
                                                       TextColor="{StaticResource Gray500Jazer}" FontSize="12"
                                                       VerticalOptions="Center" LineBreakMode="TailTruncation"/>
                                                
                                                <!-- Check -->
                                                <Border Grid.Column="2" HeightRequest="24" WidthRequest="24" 
                                                        StrokeShape="RoundRectangle 12" StrokeThickness="2"
                                                        Stroke="{StaticResource Gray300Jazer}" BackgroundColor="Transparent">
                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border" Binding="{Binding EstaSeleccionada}" Value="True">
                                                            <Setter Property="BackgroundColor" Value="{StaticResource Green500}"/>
                                                            <Setter Property="Stroke" Value="{StaticResource Green500}"/>
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                    <Path Data="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" 
                                                          Fill="White" WidthRequest="14" HeightRequest="14"
                                                          Aspect="Uniform" HorizontalOptions="Center" VerticalOptions="Center"
                                                          IsVisible="{Binding EstaSeleccionada}"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Footer -->
                    <Border Grid.Row="2" BackgroundColor="{StaticResource Gray50}" Padding="24,16" StrokeThickness="0">
                        <Button Text="Listo" 
                                BackgroundColor="{StaticResource Blue600}" TextColor="White"
                                HeightRequest="44" CornerRadius="10" FontAttributes="Bold"
                                Command="{Binding CerrarPanelEtiquetasCommand}"/>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>